<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VitePress</title>
    <meta name="description" content="bolg ...">
    <meta name="generator" content="VitePress v1.0.0-rc.44">
    <link rel="preload stylesheet" href="/assets/style.D7tJyL4t.css" as="style">
    
    <script type="module" src="/assets/app.M4SaE_Uz.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Bu8hRsVA.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.DOBBHlqS.js">
    <link rel="modulepreload" href="/assets/chunks/theme.5SL8XQwR.js">
    <link rel="modulepreload" href="/assets/chunks/katex.CfZphoad.js">
    <link rel="modulepreload" href="/assets/chunks/dagre-4EVJKHTY.Js3O8cE3.js">
    <link rel="modulepreload" href="/assets/chunks/c4Diagram-6F5ED5ID.DeQw4xUz.js">
    <link rel="modulepreload" href="/assets/chunks/flowDiagram-7ASYPVHJ.Rp0YRhov.js">
    <link rel="modulepreload" href="/assets/chunks/erDiagram-6RL3IURR.DoB0OGnt.js">
    <link rel="modulepreload" href="/assets/chunks/gitGraphDiagram-NRZ2UAAF.ChsJBDxA.js">
    <link rel="modulepreload" href="/assets/chunks/ganttDiagram-NTVNEXSI.CIepkXmA.js">
    <link rel="modulepreload" href="/assets/chunks/infoDiagram-A4XQUW5V.CHlaMzLV.js">
    <link rel="modulepreload" href="/assets/chunks/pieDiagram-YF2LJOPJ.BQ1C0G6z.js">
    <link rel="modulepreload" href="/assets/chunks/quadrantDiagram-OS5C2QUG.C0ojte94.js">
    <link rel="modulepreload" href="/assets/chunks/xychartDiagram-6QU3TZC5.Dxq1MJ5s.js">
    <link rel="modulepreload" href="/assets/chunks/requirementDiagram-MIRIMTAZ.DKwpVhl2.js">
    <link rel="modulepreload" href="/assets/chunks/sequenceDiagram-G6AWOVSC.CRiT4c1P.js">
    <link rel="modulepreload" href="/assets/chunks/classDiagram-LNE6IOMH.D-HM0iEj.js">
    <link rel="modulepreload" href="/assets/chunks/classDiagram-v2-MQ7JQ4JX.D-HM0iEj.js">
    <link rel="modulepreload" href="/assets/chunks/stateDiagram-MAYHULR4.kmiO26yv.js">
    <link rel="modulepreload" href="/assets/chunks/stateDiagram-v2-4JROLMXI.B-YwTWas.js">
    <link rel="modulepreload" href="/assets/chunks/journeyDiagram-G5WM74LC.BXxla0Q4.js">
    <link rel="modulepreload" href="/assets/chunks/timeline-definition-U7ZMHBDA.CJQwN5OS.js">
    <link rel="modulepreload" href="/assets/chunks/mindmap-definition-GWI6TPTV.BWcM55w_.js">
    <link rel="modulepreload" href="/assets/chunks/kanban-definition-QRCXZQQD.CM7gD5yk.js">
    <link rel="modulepreload" href="/assets/chunks/sankeyDiagram-Y46BX6SQ.D7CvAvWI.js">
    <link rel="modulepreload" href="/assets/chunks/diagram-QW4FP2JN.dcFyXh5Y.js">
    <link rel="modulepreload" href="/assets/chunks/blockDiagram-ZHA2E4KO.CnsXt69T.js">
    <link rel="modulepreload" href="/assets/chunks/architectureDiagram-UYN6MBPD.NcqJ17ZR.js">
    <link rel="modulepreload" href="/assets/chunks/virtual_mermaid-config.DDnGl6nM.js">
    <link rel="modulepreload" href="/assets/document_workers_timehut_小屋服务启动管理.md.1Qp2eL3p.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div><div class="w-screen h-[0px]"><!----></div><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar" data-v-7ad780c2 data-v-3efcd581><div class="wrapper" data-v-3efcd581><div class="container" data-v-3efcd581><div class="title" data-v-3efcd581><div class="VPNavBarTitle" data-v-3efcd581 data-v-0ad69264><a class="title" href="/" data-v-0ad69264><!--[--><!--]--><!----><span data-v-0ad69264>Zouzhu&#39;s Wiki</span><!--[--><!--]--></a></div></div><div class="content" data-v-3efcd581><div class="content-body" data-v-3efcd581><!--[--><!--]--><div class="VPNavBarSearch search" data-v-3efcd581><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-3efcd581 data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>首页</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="mailto:zouzhuqorg@gmail.com" target="_blank" rel="noreferrer" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>联系我</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-3efcd581 data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-283b26e9 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-3efcd581 data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/zouzhu-code-89" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><a class="VPSocialLink no-icon" href="..." aria-label="twitter" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-twitter" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-3efcd581 data-v-8e87c032 data-v-af5898d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-af5898d3><span class="vpi-more-horizontal icon" data-v-af5898d3></span></button><div class="menu" data-v-af5898d3><div class="VPMenu" data-v-af5898d3 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-8e87c032><div class="item appearance" data-v-8e87c032><p class="label" data-v-8e87c032>Appearance</p><div class="appearance-action" data-v-8e87c032><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-8e87c032 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div></div></div><div class="group" data-v-8e87c032><div class="item social-links" data-v-8e87c032><div class="VPSocialLinks social-links-list" data-v-8e87c032 data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/zouzhu-code-89" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><a class="VPSocialLink no-icon" href="..." aria-label="twitter" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-twitter" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-3efcd581 data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-3efcd581><div class="divider-line" data-v-3efcd581></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-0b5c97a1><button data-v-0b5c97a1>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-6b52fe58><div class="content" data-v-6b52fe58><div class="outline-marker" data-v-6b52fe58></div><div class="outline-title" role="heading" aria-level="2" data-v-6b52fe58>目录大纲</div><nav aria-labelledby="doc-outline-aria-label" data-v-6b52fe58><span class="visually-hidden" id="doc-outline-aria-label" data-v-6b52fe58> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-6b52fe58 data-v-53c99d69><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _document_workers_timehut_%E5%B0%8F%E5%B1%8B%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E7%AE%A1%E7%90%86" data-v-e6f2a212><div><h2 id="小屋服务器启动管理" tabindex="-1">小屋服务器启动管理 <a class="header-anchor" href="#小屋服务器启动管理" aria-label="Permalink to &quot;小屋服务器启动管理&quot;">​</a></h2><h3 id="启动-rails-与-启动-sidekiq" tabindex="-1">”启动 Rails” 与 “启动 Sidekiq“ <a class="header-anchor" href="#启动-rails-与-启动-sidekiq" aria-label="Permalink to &quot;”启动 Rails” 与 “启动 Sidekiq“&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">puma</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sidekiq</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 启动</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">冷启动：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> service puma start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> restart</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> service sidekiq start </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> restart</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">普通重启：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ./script/restart.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ./script/worker_daemon.sh</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sidekiq</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 后台地址：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    新版：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        cn:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://beta.shiguangxiaowu.cn/sidekiq</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        hk:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://beta.peekaboomoments.com/sidekiq</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    旧版(后面会废弃</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        cn:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://admin.shiguangxiaowu.cn/sidekiq</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        hk:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://admin.peekaboomoments.com/sidekiq</span></span></code></pre></div><h2 id="接口文档及说明" tabindex="-1">接口文档及说明 <a class="header-anchor" href="#接口文档及说明" aria-label="Permalink to &quot;接口文档及说明&quot;">​</a></h2><h3 id="通过分享链接邀请家人" tabindex="-1">通过分享链接邀请家人 <a class="header-anchor" href="#通过分享链接邀请家人" aria-label="Permalink to &quot;通过分享链接邀请家人&quot;">​</a></h3><p>1.分享出来的链接 /fis/a?shareCode=4800703 页面调用 /family_invitations/accept<br> 2.接受邀请会访问 /family_invitations/pre_accepted 获取 code 并返回，然后通过 openinstall 跳转到客户端 (携带了 code 参数)<br> 3.跳转到客户端后，客户端会调用 /family_invitations/connect 预接受处<br> FamilyInvitation 状态会变成 accepted，建立关系在 FamilyInvitation model 回调里面.</p><p>FamilyRelation 关系里面的 accepter_id 是关联的 FamilyInvitation</p><h3 id="移除孩子或更新家人信息" tabindex="-1">移除孩子或更新家人信息 <a class="header-anchor" href="#移除孩子或更新家人信息" aria-label="Permalink to &quot;移除孩子或更新家人信息&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>PUT family_relations/refresh</span></span></code></pre></div><h3 id="日记上传创建-moment" tabindex="-1">日记上传创建 moment <a class="header-anchor" href="#日记上传创建-moment" aria-label="Permalink to &quot;日记上传创建 moment&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>POST /baby_contents</span></span></code></pre></div><h3 id="时光小屋接口结构" tabindex="-1">时光小屋接口结构 <a class="header-anchor" href="#时光小屋接口结构" aria-label="Permalink to &quot;时光小屋接口结构&quot;">​</a></h3><div class="mermaid">null</div><h3 id="时光小屋推送结构" tabindex="-1">时光小屋推送结构 <a class="header-anchor" href="#时光小屋推送结构" aria-label="Permalink to &quot;时光小屋推送结构&quot;">​</a></h3><div class="mermaid">null</div><h3 id="时光小屋表结构" tabindex="-1">时光小屋表结构 <a class="header-anchor" href="#时光小屋表结构" aria-label="Permalink to &quot;时光小屋表结构&quot;">​</a></h3><div class="mermaid">null</div><h2 id="vip-相关操作代码块" tabindex="-1">VIP 相关操作代码块 <a class="header-anchor" href="#vip-相关操作代码块" aria-label="Permalink to &quot;VIP 相关操作代码块&quot;">​</a></h2><h3 id="验证订单-payment" tabindex="-1">验证订单 Payment <a class="header-anchor" href="#验证订单-payment" aria-label="Permalink to &quot;验证订单 Payment&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Payment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1590</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).verify_again</span></span></code></pre></div><h3 id="购买-vip-开启沙盒环境" tabindex="-1">购买 VIP 开启沙盒环境 <a class="header-anchor" href="#购买-vip-开启沙盒环境" aria-label="Permalink to &quot;购买 VIP 开启沙盒环境&quot;">​</a></h3><p>app/services/apple_pay_manager.rb ，将 debug 固定改为 true</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">host </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> debug</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;sandbox.itunes.apple.com&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  &#39;buy.itunes.apple.com&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="vip-优惠卷发送" tabindex="-1">VIP 优惠卷发送 <a class="header-anchor" href="#vip-优惠卷发送" aria-label="Permalink to &quot;VIP 优惠卷发送&quot;">​</a></h3><p>PromotionCode.operation 发送优惠卷 promotion_code.notifier 发送优惠卷通知</p><h2 id="小屋-vip-知识梳理" tabindex="-1">小屋 VIP 知识梳理 <a class="header-anchor" href="#小屋-vip-知识梳理" aria-label="Permalink to &quot;小屋 VIP 知识梳理&quot;">​</a></h2><h2 id="用户反馈操作代码块" tabindex="-1">用户反馈操作代码块 <a class="header-anchor" href="#用户反馈操作代码块" aria-label="Permalink to &quot;用户反馈操作代码块&quot;">​</a></h2><h3 id="为用户开放每日一拍" tabindex="-1">为用户开放每日一拍 <a class="header-anchor" href="#为用户开放每日一拍" aria-label="Permalink to &quot;为用户开放每日一拍&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BabyMomentTagAttr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 540498005</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 581913</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tag_desc:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tag_day_desc:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">comments_count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">likes_count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">usn:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 35858951</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tag_name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;每日一拍&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">insurance:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">day:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span></span></code></pre></div><h3 id="恢复用户数据重新生成-event" tabindex="-1">恢复用户数据重新生成 Event <a class="header-anchor" href="#恢复用户数据重新生成-event" aria-label="Permalink to &quot;恢复用户数据重新生成 Event&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1.修改孩子的时区</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fix_time_zone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.moments.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |moment|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.from_age(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.zone.at(moment.taken_at_gmt)).tap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |m, d|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        moment.total_days </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.from_age_pair m, d</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      moment.save</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2.还要调 baby event rebuild 重置状态</span></span></code></pre></div><h3 id="批量修改用户孩子-moment-权限" tabindex="-1">批量修改用户孩子 moment 权限 <a class="header-anchor" href="#批量修改用户孩子-moment-权限" aria-label="Permalink to &quot;批量修改用户孩子 moment 权限&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> batch_moments_privacy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(baby_id, user_id, to)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(baby_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(user_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  relation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserRelationManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.baby_user_relation(baby, user)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  options </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">from:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;private&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;parents&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;myself&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">to:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> to, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">uid:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">role:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relation.role, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">visible_for_ids:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [] }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  BabyMomentsWorker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform baby.id, options</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="查找用户的标签-以及标签下的数据量" tabindex="-1">查找用户的标签，以及标签下的数据量 <a class="header-anchor" href="#查找用户的标签-以及标签下的数据量" aria-label="Permalink to &quot;查找用户的标签，以及标签下的数据量&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查找</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> baby_tags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  moment_tag_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    moment_tag_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:moment_tag_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    MomentTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_tag_ids).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |moment_tag|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby_moment_tag_attr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyMomentTagAttr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_tag.id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      tagging_records </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_tag.id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_moment_tag_attr</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;标签名称(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moment_tag.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">): </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moment_tag.tag_name[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zh-TW&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> / 资源: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{tagging_records.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 个&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.green</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;标签名称(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moment_tag.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">): </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moment_tag.tag_name[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zh-TW&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> / 资源: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{tagging_records.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 个&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.red</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      moment_tag_id.push(moment_tag.id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  moment_tag_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 恢复</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> restore_tag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid, moment_tag_id)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ActiveRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Base</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.transaction </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      moment_tag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MomentTag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(moment_tag_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby_moment_tag_attr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyMomentTagAttr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_or_initialize_by </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_tag.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tag_name:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_tag.tag_name[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zh-TW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_tag.user_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby_moment_tag_attr.save!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_tag.id).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |tagging_record|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        moment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tagging_record.moment</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tagging_record.update! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.active </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">moment.raw_remove? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tagging_record.active</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="修复日记-moment-的-fields-为字符串时产生的报错" tabindex="-1">修复日记 moment 的 fields 为字符串时产生的报错 <a class="header-anchor" href="#修复日记-moment-的-fields-为字符串时产生的报错" aria-label="Permalink to &quot;修复日记 moment 的 fields 为字符串时产生的报错&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rich_text_data_repair</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(baby_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(baby_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        moments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).find_each.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { |item| item.fields.is_a?(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        moments.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |m|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m.type}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m.fields.class}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.fields</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            m.update! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fields:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(m.fields)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="小屋服务维护" tabindex="-1">小屋服务维护 <a class="header-anchor" href="#小屋服务维护" aria-label="Permalink to &quot;小屋服务维护&quot;">​</a></h2><h3 id="momentworker-移动复制报错处理" tabindex="-1">MomentWorker 移动复制报错处理 <a class="header-anchor" href="#momentworker-移动复制报错处理" aria-label="Permalink to &quot;MomentWorker 移动复制报错处理&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> moment_worker_bug_fixs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type, moment_worker_params)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_worker_params[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;baby_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  to_baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_worker_params[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;to_baby_ids&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  moment_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_worker_params[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;moment_ids&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(baby_id).secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_ids).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |m|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;picture&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        m.picture</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      elsif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;video&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.video_hd.present?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        m.video_hd</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        m.video</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OssManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ObjectProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(path).aliyun_info</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;not exist&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        to_baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(to_baby_ids.last)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        to_baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> to_baby.moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.id).count</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, moment id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> moment count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{to_baby.moments.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;我来了: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.raw_remove?) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.active</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;操作的 moment id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # m.update active: false</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span></code></pre></div><h3 id="备份服务删除" tabindex="-1">备份服务删除 <a class="header-anchor" href="#备份服务删除" aria-label="Permalink to &quot;备份服务删除&quot;">​</a></h3><ul><li><p>Bebememo 保留 90 天</p></li><li><p>小屋国内保留 5 个月</p></li><li><p>小屋港台保留 3 个月</p></li></ul><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># frozen_string_literal: true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Util</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SnapManager</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 备份数据删除</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> snap_delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(datatime, reload_logs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.zone </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Beijing&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(datatime).to_i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      root_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/moments_backups/momentbackups&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      Dir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.entries(root_path).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby_id_folder|</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 过滤 ..</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;..&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(baby_id_folder)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 是否存在目录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        baby_folder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.join(root_path, baby_id_folder)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.directory?(baby_folder)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 目录修改时间大于限定时间，不处理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        baby_folder_edit_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.mtime(baby_folder).to_i</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_folder_edit_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 如果为 vip 不删</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(baby_id_folder)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # next if baby.active || baby.vip?</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 查询孩子备份数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        snapshots </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.snapshots.generated</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 删除孩子备份数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        Dir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.entries(baby_folder).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |package_file_name|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;..&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(package_file_name)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          package_file_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.join(baby_folder, package_file_name)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.file? package_file_path</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          package_file_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.mtime(package_file_path).to_i</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> package_file_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            snap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> snapshots.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;path LIKE ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;%</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{package_file_name}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">%&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).last</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            Rails</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.error </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.now.strftime(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%Y/%m/%d %H:%M:%S&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &gt;&gt; 开始删除 baby(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{baby_id_folder}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">), active?: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{baby.active}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, vip?: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{baby.vip?}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, file: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{package_file_path}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, 文件修改时间为: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.at(package_file_time).strftime(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> snapshots: (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{snap.try(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:started_at</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> / </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{snap.try(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:ended_at</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            FileUtils</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.rm(package_file_path)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          reload_logs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> inspect_ngnix_log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reload_logs, package_file_name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      is_exist </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      log_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/var/log/openresty&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      log_copy_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/var/log/openresty-copy&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reload_logs</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        `sudo rm -fr </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{log_copy_path}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &amp;&amp; sudo cp -r </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{log_path}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> #{log_copy_path}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        Dir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.entries(log_copy_path).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |log_file|</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          `sudo gzip -d </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">File</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.join(log_copy_path, log_file)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> log_file.include? </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.gz&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      Dir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.entries(log_copy_path).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |log_file|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> log_file.include? </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.log&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `sudo tac </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">File</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.join(log_copy_path, log_file)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> | grep </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{package_file_name}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exist </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> and</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> break</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> log_info.include? package_file_name</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      is_exist</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_snap_size</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.zone </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Beijing&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      root_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/moments_backups/momentbackups&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      Dir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.entries(root_path).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby_id_folder|</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 过滤 ..</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;..&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(baby_id_folder)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 是否存在目录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        baby_folder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.join(root_path, baby_id_folder)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.directory?(baby_folder)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 删除孩子备份数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        Dir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.entries(baby_folder).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |package_file_name|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;..&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(package_file_name)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          package_file_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.join(baby_folder, package_file_name)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.file? package_file_path</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          package_file_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.mtime(package_file_path).to_i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          file_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.size(package_file_path).to_i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.at(package_file_time).strftime(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%Y%m%d&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          result[date] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result[date].to_f </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (file_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      result.sort.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |date, size|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{date}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{(size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024.0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">).round(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> G&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="搜索年龄错误的-moment" tabindex="-1">搜索年龄错误的 moment <a class="header-anchor" href="#搜索年龄错误的-moment" aria-label="Permalink to &quot;搜索年龄错误的 moment&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> moment_total_day_error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bid</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find bid</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    b.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      b.moments.active.order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:taken_at_gmt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |m|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        mm, dd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b.from_age(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.zone.at(m.taken_at_gmt))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        expect </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.from_age_pair(mm, dd)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.zone.at(m.taken_at_gmt).to_date.to_fs(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), m.total_days, expect].join(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).colorize(m.total_days </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expect </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :white</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:red</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="重跑-moment-faces" tabindex="-1">重跑 Moment Faces <a class="header-anchor" href="#重跑-moment-faces" aria-label="Permalink to &quot;重跑 Moment Faces&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> faces_reset</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">540714835</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    MomentLocation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 540714835</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">faces:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |moment_location|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_location.faces</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      moment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.fifafu(moment_location.moment_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      moment.save_faces moment_location.faces</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      moment.event.touch</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="ab-测试规则" tabindex="-1">AB 测试规则 <a class="header-anchor" href="#ab-测试规则" aria-label="Permalink to &quot;AB 测试规则&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> VipManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">VipPlansManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user, baby, state, used_for, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, options[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:android_plan</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).plans </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserVip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.versions[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:v1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 国内iOS的首年购买优惠测试</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> options[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:session_platform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].to_s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;iphone&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.user_vips.blank? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.vip_expiration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      VipPlansManager4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache_user_ids(user, baby, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;B&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> VipManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">VipPlansManager4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user, baby, state, used_for, options).plans</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      VipManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">VipPlansManager4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache_user_ids user, baby, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;A&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># cache_user_ids 里面的条件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.user_vips.blank? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.vip_expiration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;saturn:vip_discount_test:user_ids:20240202:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{plan}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |r|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 后面切换为 CD 测试</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.jp? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> options[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:session_platform</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].to_s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;iphone&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.user_vips.blank? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.vip_expiration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.country </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;IT&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    VipPlansManager4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache_user_ids(user, baby, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;C&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> VipPlansManager4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user, baby, state, used_for, options).plans_c</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    VipPlansManager4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache_user_ids user, baby, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;D&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> VipPlansManager4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user, baby, state, used_for, options).plans_d</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="修复-web-上传没有宽高" tabindex="-1">修复 WEB 上传没有宽高 <a class="header-anchor" href="#修复-web-上传没有宽高" aria-label="Permalink to &quot;修复 WEB 上传没有宽高&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fix_moment_wh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture_width:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).picture_or_video.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |m|</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 下载文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      original_file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StorageManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.download(m.picture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.video_hd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.video, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      file_bytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.binread(original_file.path, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">w[heic </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">HEIC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> heif </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">HEIF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].find { |item| file_bytes.include? item }.present?</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.delete(original_file.path) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.file?(original_file.path)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        original_file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StorageManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.download(path, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 修正</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      image </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MiniMagick</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> original_file.path</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> path: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{original_file.path}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> width: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{image.width}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> height: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{image.height}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      m.update! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture_width:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image.width, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture_height:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image.height</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="周活-vip-孩子跑-moment-faces" tabindex="-1">周活 VIP 孩子跑 Moment Faces <a class="header-anchor" href="#周活-vip-孩子跑-moment-faces" aria-label="Permalink to &quot;周活 VIP 孩子跑 Moment Faces&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_access_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.month.ago.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">runed_baby_ids_0619 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SMEMBERS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;saturn:faces_worker:baby_ids:20240619&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }.map(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:to_i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">runed_baby_ids_0801 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SMEMBERS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;saturn:faces_worker:baby_ids:20240801&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }.map(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:to_i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">runed_baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> runed_baby_ids_0619 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> runed_baby_ids_0801</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> runed_baby_ids).active.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SADD</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;saturn:faces_worker:baby_ids:20240801&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, baby.id }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  MomentFacesWorker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform_async baby.id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## 2024-08-01 国内量: 268146  港台量: 123290     限定条件：6个月月活，没有限定VIP</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_access_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.month.ago.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_ids).active.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SADD</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;saturn:faces_worker:baby_ids:20240807&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, baby.id }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  MomentFacesWorker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform_async baby.id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## 2024-08-07 国内量: 431553  港台量:437994     限定条件：6个月月活，没有限定VIP  (跑第二轮)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_access_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.month.ago.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_ids).active.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.sadd </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;bebememo:faces_worker:baby_ids:20241012&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, baby.id }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.expire </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;bebememo:faces_worker:baby_ids:20241012&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.months.to_i }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  MomentFacesWorker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform_async baby.id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## 2024-10-12 bebememo: 261710     限定条件：6个月月活，没有限定VIP  (跑第1轮)</span></span></code></pre></div><h3 id="sidekiq-dead-处理" tabindex="-1">Sidekiq Dead 处理 <a class="header-anchor" href="#sidekiq-dead-处理" aria-label="Permalink to &quot;Sidekiq Dead 处理&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;sidekiq/api&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ds </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Sidekiq</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DeadSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ds.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |work|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  event_name, params </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> work.args</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;restore_moment&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    moment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.fifafu params[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;moment_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.service </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;tencent_gz&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      work.delete</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="查询-es-检索量大的孩子" tabindex="-1">查询 ES 检索量大的孩子 <a class="header-anchor" href="#查询-es-检索量大的孩子" aria-label="Permalink to &quot;查询 ES 检索量大的孩子&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_access_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.week.ago.to_i).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby_activity|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_activity.baby</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.active.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">content:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;source is null or source != ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;to_be_delete&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).count</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;bid: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{baby.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536924782</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536927196</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536944488</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536951205</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536951248</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536965603</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536984175</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536987501</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 536990832</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5949</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">536995920</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 536995920</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5500</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 搜索孩子的关键字</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> search_content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    contents </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.active.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">content:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;source is null or source != ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;to_be_delete&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :asc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:content</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> contents</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="moment-faces-任务中-修复-moment-有问题的数据" tabindex="-1">Moment Faces 任务中，修复 moment 有问题的数据 <a class="header-anchor" href="#moment-faces-任务中-修复-moment-有问题的数据" aria-label="Permalink to &quot;Moment Faces 任务中，修复 moment 有问题的数据&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> restore_moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mid, duration)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  moment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.fifafu(mid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  video_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.picture</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  video_file_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.picture_file_size</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Common</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform_in </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.to_i, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;delete_oss_object&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">path:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video_hd }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  moment.update_columns </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;video&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture_file_size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video_hd:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video_hd_file_size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_path, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video_file_size:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_file_size, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">duration:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> duration, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">raw_remove:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.service.to_s.include? </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aliyun&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    TranscodeMonitor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dispatch_job moment</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="查询邮件有多少人" tabindex="-1">查询邮件有多少人 <a class="header-anchor" href="#查询邮件有多少人" aria-label="Permalink to &quot;查询邮件有多少人&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">birthday:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> con).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">country:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;KR&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.linked_user.family_relations.active.checked.family.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">relation:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mom&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dad&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i</span></span></code></pre></div><h3 id="查询复用-根据-path-查-moment" tabindex="-1">（查询复用）根据 path 查 moment <a class="header-anchor" href="#查询复用-根据-path-查-moment" aria-label="Permalink to &quot;（查询复用）根据 path 查 moment&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 通过家人找 moment</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cat_path_for_moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(uid, path)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(uid).family_relations.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr.with_user.linked_baby</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;baby moments count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{baby.moments.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      moments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video = ? or video_hd = ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, path, path)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mids: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moments.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moments.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> baby_to_moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid, mid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(mid).picture</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.linked_user.family_relations.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr1|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fr1.with_user.family_relations.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr2|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      linked_baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr2.with_user.linked_baby</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      linked_baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        moments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> path)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mids: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moments.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moments.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 遍历分片，全量查找</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cat_path_for_moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(path)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ShardHelper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    moments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video = ? or video_hd = ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, path, path)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moments.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mids: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moments.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      break</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="查询冷门功能" tabindex="-1">查询冷门功能 <a class="header-anchor" href="#查询冷门功能" aria-label="Permalink to &quot;查询冷门功能&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 每日一拍</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_access_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BabyMomentTagAttr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_ids, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;428225&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq.count</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_babys1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |bid|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.use_shard</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tagging_records </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 581_913</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt; ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.day.ago)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tagging_records.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    use_babys1.push(bid)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 生日记录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_babys2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_access_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BabyMomentTagAttr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_ids, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;newbirthday&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |bmta|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bmta.baby_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.use_shard</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tagging_records </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bmta.moment_tag_id).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt; ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.day.ago)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tagging_records.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    use_babys2.push(baby.id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 里程碑</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_babys3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_access_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BabyMomentTagAttr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_ids, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;newmilestone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |bmta|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bmta.baby_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.use_shard</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tagging_records </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bmta.moment_tag_id).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt; ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.day.ago)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tagging_records.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    use_babys3.push(baby.id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 照片美化、贴纸</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">m_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mb_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ShardHelper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  m_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago).picture_or_video.count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  mb_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago).picture_or_video.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">beauty_picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;m_count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m_count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mb_count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{mb_count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># AI 功能</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">m_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mb_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ShardHelper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  moments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;iphone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;iphone_ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).picture_or_video</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  m_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moments.count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  mb_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;iphone_ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;m_count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m_count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mb_count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{mb_count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_baby4 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_baby41 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserSession</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;accessed_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_ids.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |uid|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(uid)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.after_version(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;560&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;708&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;20211116&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).beginning_of_day</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user.family_relations.active_family_checked.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fr_peer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr.peer</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mom&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dad&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(fr_peer.relation)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      use_baby4.push([fr_peer.user.linked_baby.id, user.id])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">m_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mb_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cat_bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_baby4.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |bid, uid|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cat_bids.include?(bid)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.use_shard</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  moments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uid).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;iphone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;iphone_ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).picture_or_video</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  m_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moments.count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  mb_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;iphone_ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).count</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  cat_bids.push(bid)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;m_count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m_count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mb_count: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{mb_count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 资料夹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_babys8 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserSession</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_ids).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at &lt;= ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Date</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2020.10.15&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).end_of_day).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |user|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.linked_baby</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.use_shard</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tagging_records </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">271_229</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">271_230</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">276_150</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt; ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.day.ago)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tagging_records.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    use_babys8.push(baby.id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">use_babys8 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_access_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.ago.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BabyMomentTagAttr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_ids, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">271_229</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">271_230</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">276_150</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |bmta|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bmta.baby_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.use_shard</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tagging_records </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">271_229</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">271_230</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">276_150</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt; ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.day.ago)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tagging_records.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    use_babys8.push(baby.id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="移动复制数据修复" tabindex="-1">移动复制数据修复 <a class="header-anchor" href="#移动复制数据修复" aria-label="Permalink to &quot;移动复制数据修复&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> restore_moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(moment_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  video_hd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.fifafu(moment_id)&amp;.video_hd</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">537099126</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.use_shard</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video_hd:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd).last&amp;.id</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">540680460</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.use_shard</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  copy_video_hd </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id).last&amp;.video_hd</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> copy_video_hd</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;找到了.............&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;https://alihk.peekaboocdn.com/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{video_hd}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    StorageManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.send </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;aliyun_object_copy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, copy_video_hd, video_hd, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hk&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> check_repeat?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user, baby, field, path)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  is_exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user.family_relations.checked.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    linked_baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr.with_user.linked_baby</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    linked_baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 虽然照片被复用，当全部的复用都经过用户转移操作后，依然删除</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      is_exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{field}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: path</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{is_exists}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{field}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: path).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;linked_baby id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{linked_baby.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  #{ids.to_s}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  is_exists</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> check_repeat?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user, mid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  is_exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user.family_relations.checked.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    linked_baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr.with_user.linked_baby</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    linked_baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 虽然照片被复用，当全部的复用都经过用户转移操作后，依然删除</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      is_exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mid</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{is_exists}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mid).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;linked_baby id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{linked_baby.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  #{ids.to_s}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  is_exists</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby.linked_user.family_relations.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr.with_user</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  check_repeat? user, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">915347860022876159</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="faces-修复宽高" tabindex="-1">Faces 修复宽高 <a class="header-anchor" href="#faces-修复宽高" aria-label="Permalink to &quot;Faces 修复宽高&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(baby_id).use_shard</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(baby_id).moments.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;picture LIKE ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%.mp4&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:picture</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:video_hd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:duration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(baby_id).moments.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;picture LIKE ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%.mp4&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:picture</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:video_hd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:duration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each { |item| restore_error_moment </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(item[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]) }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 修复旧数据 moment picture 赋值为 video 的问题</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> restore_error_moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(moment)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  picture_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OssManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ObjectProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(moment.picture).aliyun_info</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;not exist&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture_info.headers[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:content_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;video&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 场景1: picture 是视频, video 是图片，video_hd 转码错误的</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video.include?(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;pictures&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;.jpg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;jpeg&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].any? { |type| moment.video.include?(type) } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.duration.to_i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 获取 duration 时长</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    duration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> FFMPEG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Movie</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(moment.picture_url(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)).duration</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 删除旧的 video、video_hd 并重新赋值</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Common</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform_in </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.to_i, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;delete_oss_object&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">path:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Common</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform_in </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.to_i, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;delete_oss_object&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">path:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video_hd }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    moment.update! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;video&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture_file_size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.picture, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video_file_size:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.picture_file_size, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">raw_remove:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video_hd:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video_hd_file_size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">duration:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> duration.to_i</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 重新转码</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    TranscodeMonitor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.dispatch_job moment, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.service.to_s.include?(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aliyun&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 场景2: picture 是视频, video 是视频，video_hd 转码正确的</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  elsif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video.include?(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;video&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.duration.to_i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video_hd.present?</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Common</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform_in </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days.to_i, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;delete_oss_object&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">path:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.picture } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.picture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    moment.update! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;video&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture_file_size:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="标签准确率和回复准确率" tabindex="-1">标签准确率和回复准确率 <a class="header-anchor" href="#标签准确率和回复准确率" aria-label="Permalink to &quot;标签准确率和回复准确率&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.send_by_user.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.month.ago.all_month).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lang:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ja&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).group(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:reply_correct_value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">375</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">007</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.send_by_user.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.month.ago.all_month).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lang:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ja&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).group(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:tag_correct_value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; {</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">375</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="查找用户上传照片平均数" tabindex="-1">查找用户上传照片平均数 <a class="header-anchor" href="#查找用户上传照片平均数" aria-label="Permalink to &quot;查找用户上传照片平均数&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  range </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-08-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).beginning_of_day .. </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-09-01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).beginning_of_day</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> range, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;iphone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;id % 10 &lt; 3&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">phone:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).adopted.active</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;用户数量: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{users.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  users.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |user|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user.family_relations.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      bid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr.with_user.linked_baby.id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{user.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bid}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr.with_user.is_baby? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bids.include?(info)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        bids.push(info)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;孩子数量: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bids.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  m_length </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  moment_range </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-10-22&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).beginning_of_day .. </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-10-28&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).beginning_of_day</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  accessed_users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">accessed_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_range).count</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;用户访问数量: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{accessed_users}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  bids.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |info|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    uid, bid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> info.split(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;_&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      m_length </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uid).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment_range).picture.count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;照片数量: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m_length}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span></code></pre></div><h3 id="移动复制德国节点-moment" tabindex="-1">移动复制德国节点 Moment <a class="header-anchor" href="#移动复制德国节点-moment" aria-label="Permalink to &quot;移动复制德国节点 Moment&quot;">​</a></h3><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>MomentWorker </span></span>
<span class="line"><span></span></span>
<span class="line"><span>&quot;batch_copy&quot;, {&quot;user_id&quot;=&gt;540892147, &quot;moment_ids&quot;=&gt;[1436940094984632366], &quot;baby_id&quot;=&gt;540830670, &quot;to_baby_ids&quot;=&gt;[540670351]}</span></span>
<span class="line"><span>&quot;batch_copy&quot;, {&quot;user_id&quot;=&gt;540892147, &quot;moment_ids&quot;=&gt;[1436940094984632366], &quot;baby_id&quot;=&gt;540830670, &quot;to_baby_ids&quot;=&gt;[540670351]}</span></span>
<span class="line"><span>&quot;batch_copy&quot;, {&quot;user_id&quot;=&gt;540892147, &quot;moment_ids&quot;=&gt;[1436940094984632366], &quot;baby_id&quot;=&gt;540830670, &quot;to_baby_ids&quot;=&gt;[540670351]}</span></span></code></pre></div><h3 id="获取冷存档孩子" tabindex="-1">获取冷存档孩子 <a class="header-anchor" href="#获取冷存档孩子" aria-label="Permalink to &quot;获取冷存档孩子&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">archive_status:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;archived&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |ba|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ba.baby.active</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   bid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ba.baby_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   archive_status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.get </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;saturn:archive_status:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bid}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;bid: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bid}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> archive_status</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="美化照片迁移" tabindex="-1">美化照片迁移 <a class="header-anchor" href="#美化照片迁移" aria-label="Permalink to &quot;美化照片迁移&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># frozen_string_literal: true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Util::BeautyMigrateScript</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 查找美化过照片的孩子</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> beauty_moments</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    shard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ShardHelper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">beauty_picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).active.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@shard</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{shard}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bids.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      shard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |r|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        r.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SADD</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;saturn:use_beauty_picture_baby:20241107&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, bids</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> avg_beauty_num</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    total_num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SMEMBERS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;saturn:use_beauty_picture_baby:20241107&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bids).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.active.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">beauty_picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        total_num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;bid: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{baby.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, num: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{num}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;孩子数量: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bids.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, 照片总量: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{total_num}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, 平均量: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{total_num </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bids.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 美化过的照片迁移到新的 Moment</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> beauty_picture_to_moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.moments.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">beauty_picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).active.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |moment|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        node </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StorageManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.node_from_path moment.beauty_picture</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        service </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TokenManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, node).send </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:upload_service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, node</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 创建新的 moment</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        new_moment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.as_json </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">except:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:beauty_picture</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:edits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        new_moment[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;picture&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.beauty_picture</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        new_moment[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;service&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        baby.moments.create! new_moment</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 旧的 moment 把美化照片置空</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        moment.update! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">beauty_picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">edits:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> avg_shard_num</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    shard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ShardHelper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> shard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      moments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">beauty_picture:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).active</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moments.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;bids: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bids}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      all_moments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bids).active.picture</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;@shard</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{shard}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: mids: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moments.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  bids: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bids.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  baby all moments: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{all_moments.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      shard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="当年今日-消息统计" tabindex="-1">当年今日(消息统计) <a class="header-anchor" href="#当年今日-消息统计" aria-label="Permalink to &quot;当年今日(消息统计)&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> notification_count</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;日期            总量               已读           当年今日          当年今日已读&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |i|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    range </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i.days.ago.beginning_of_day..i.days.ago.end_of_day</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    notifications </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Notification</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> range)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    read_notifications </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> notifications.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;read&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    last_moment_notifications </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> notifications.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;last_moment&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    read_last_moment_notifications </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> read_notifications.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;last_moment&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i.days.ago.to_date.to_fs(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{date}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        #{notifications.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           #{read_notifications.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          #{last_moment_notifications.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">           #{read_last_moment_notifications.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="相集描述bug-重复文案去重" tabindex="-1">相集描述BUG(重复文案去重) <a class="header-anchor" href="#相集描述bug-重复文案去重" aria-label="Permalink to &quot;相集描述BUG(重复文案去重)&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SMEMBERS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;status:add_caption_blank_bug:baby_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_ids.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |bid|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  restore_repeat_caption bid</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;****************</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bid}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">********************&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> restore_repeat_caption</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    events </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.events.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;caption LIKE ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">n%&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;updated_at &gt; ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.hour.ago)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    events.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |e|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      caption </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.caption.split(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq.join(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;(矫正前): </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{e.caption}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;(矫正后): </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{caption}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;event_id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{e.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # e.update! caption: caption</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # Pool.redis { |r| r.sadd &#39;status:add_caption_blank_bug:event_ids&#39;, e.id }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="notification-消息类型" tabindex="-1">Notification 消息类型 <a class="header-anchor" href="#notification-消息类型" aria-label="Permalink to &quot;Notification 消息类型&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3190369080</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;update&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;moment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;你为杨逸轩上传了508个新的瞬间&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3190369085</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;video&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;like&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;粉丝(老邹)赞了陈时甯（偲偲）的视频&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3190369153</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;photo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;like&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;爷爷赞了彤彤的照片&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3190369165</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;event&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;like&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;外婆赞了陆辰澈—团宝的相集&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3190376626</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;system&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;last_moment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;郭睿在5年前的成长瞬间&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h3 id="vip-分组测试代码" tabindex="-1">VIP 分组测试代码 <a class="header-anchor" href="#vip-分组测试代码" aria-label="Permalink to &quot;VIP 分组测试代码&quot;">​</a></h3><p>materials/video_templates</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># iphone G/H 测试 偶数 G 返回 vipmemorial 类型模版, 奇数 H 返回 web 方案</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.jp? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.after_version(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">9999</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8060</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plan </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.user_vips.blank? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> novip_and_space_overflow?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    plan </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (current_user.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;G&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;H&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |r|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      r.sadd </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:iphone_user_ids:20241211:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{plan}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, current_user.id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      r.expireat </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:iphone_user_ids:20241211:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{plan}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2025-12-11&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).to_i</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    plan</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  @video_template </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plan </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;G&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # @video_template.where.not(category: &#39;vipmemorial&#39;, version: 1)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  elsif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> plan </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;H&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @video_template.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">category:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vipmemorial&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @video_template.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">category:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;$in&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vipmemorial&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] })</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># android G/H 测试, 偶数 G 不返回, 奇数 H 返回 web 方案</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.jp? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.after_version(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">9999</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (current_user.user_vips.blank? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> novip_and_space_overflow?)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plan </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (current_user.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;G&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;H&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |r|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    r.sadd </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:android_user_ids:20241211:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{plan}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, current_user.id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    r.expireat </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:android_user_ids:20241211:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{plan}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2025-12-11&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).to_i</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>vips/:bid/info</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># android, iphone 孩子 vip G,H 测试</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.jp? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.after_version(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7800</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8060</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.sismember </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{current_session.platform}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_user_ids:20241211:G&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, current_user.id.to_s }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |r|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      r.sadd </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{current_session.platform}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_baby_ids:20241211:G&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, @baby.id.to_s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      r.expireat </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{current_session.platform}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_baby_ids:20241211:G&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2025-12-11&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).to_i</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  elsif</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.sismember </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{current_session.platform}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_user_ids:20241211:H&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, current_user.id.to_s }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |r|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      r.sadd </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{current_session.platform}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_baby_ids:20241211:H&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, @baby.id.to_s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      r.expireat </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;status:templates:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{current_session.platform}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_baby_ids:20241211:H&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2025-12-11&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).to_i</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>寻找A/B测试的User</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> novip_and_space_overflow?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current_user)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  babys </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.timeline_family_ids).map(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:linked_baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> babys.any? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> babys.all? { |baby| baby.vip_expiration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  babys.any? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 使用超过 500 M, 并且距离静默期 7 天内</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.space_used </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.megabytes) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (baby.created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyPayment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.quiet_perlod(baby)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.days</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">UserSession</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;accessed_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.hours.ago).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |user_session|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  current_user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_session.user</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.user_vips.blank? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> novip_and_space_overflow?(current_user)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    plan </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (current_user.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;G&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;H&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;plan: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{plan}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,   uid: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{current_user.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="寻找月活baby-导入到csv" tabindex="-1">寻找月活Baby，导入到CSV <a class="header-anchor" href="#寻找月活baby-导入到csv" aria-label="Permalink to &quot;寻找月活Baby，导入到CSV&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;csv&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_activity_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">last_access_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.month.ago.to_i..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.now.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_activity_ids).active.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CSV</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/home/ubuntu/shiguangxiaowu_month_activity_baby.csv&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;wb&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |csv|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  csv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;user_ids&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;baby_id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gender&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;avatar&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;birthday&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;pictures&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;videos&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;texts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bids).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.use_shard</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    csv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.linked_user.family_relations.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">relation:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;self&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).active_family_checked.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:with_user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).join(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;,&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.id,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.gender,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.linked_user.profile_picture,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.birthday.to_s,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.moments.picture.active.count,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.moments.video.active.count,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      baby.moments.rich_text.active.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.text.active.count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rsync </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">avz ubuntu@beta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">jp:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">home</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buntu</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">shiguangxiaowu_month_activity_baby.csv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">no.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Desktop</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby_activity_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">last_access_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.month.ago.to_i..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.now.to_i).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_activity_ids).active.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bids.count</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.zone </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Beijing&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/home/ubuntu/shiguangxiaowu_month_activity_baby.json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;w&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |file|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bids).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby_counter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyCounter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(baby.id).stats([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:pictures</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:texts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:videos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        user_ids:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby&amp;.linked_user&amp;.family_relations&amp;.where&amp;.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">relation:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;self&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)&amp;.active_family_checked&amp;.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:with_user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)&amp;.to_a,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        name:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.name,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        gender:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.gender,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        avatar:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby&amp;.linked_user&amp;.profile_picture,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        birthday:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.birthday.to_s,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        pictures:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_counter[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:pictures</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        videos:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_counter[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:videos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        texts:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_counter[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:texts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        created_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.created_at.to_s,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        vip_expiration:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.at(baby.vip_expiration).to_s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      file.write(data.to_json </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;还剩: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">rsync </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">avz ubuntu@beta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sz:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">home</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buntu</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">shiguangxiaowu_month_activity_baby.json </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">no.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Desktop</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span></span></code></pre></div><h3 id="获取冷存档moment" tabindex="-1">获取冷存档Moment <a class="header-anchor" href="#获取冷存档moment" aria-label="Permalink to &quot;获取冷存档Moment&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">storage_class:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Moment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.storage_classes[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:cold_archive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).active.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |moment|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  field </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;video&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (moment[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:video_hd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].present? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :video_hd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:video</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) : </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:picture</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  storage_class </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OssManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ObjectProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(moment[field]).aliyun_info.headers[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:x_oss_storage_class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> storage_class </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ColdArchive&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;moment_id: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moment.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="日记视频转码被删除-恢复" tabindex="-1">日记视频转码被删除 (恢复) <a class="header-anchor" href="#日记视频转码被删除-恢复" aria-label="Permalink to &quot;日记视频转码被删除 (恢复)&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">include</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Foundation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Cdnable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rich_text_video_restore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.moments.active.rich_text.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |m|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fields </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m.fields</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fields[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;moments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fields[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;moments&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].map </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |content|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> content[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;video&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> content[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;video_path&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;original&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          baby_content </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.baby_contents.video.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> content[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;id_str&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]).last</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          content[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;video_path&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cdn_url(baby_content.video_hd) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_content.video_hd.present?</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        content</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      m.update! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fields:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fields</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="用户注册关系分布" tabindex="-1">用户注册关系分布 <a class="header-anchor" href="#用户注册关系分布" aria-label="Permalink to &quot;用户注册关系分布&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">relations </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at &gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2025-02-12&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |user|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.is_baby?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user_count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user.family_relations.active_family_checked.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">relation:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;self&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    relations[fr.relation] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relations[fr.relation].to_i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> relations</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_count</span></span></code></pre></div><h3 id="音频模版资源上传" tabindex="-1">音频模版资源上传 <a class="header-anchor" href="#音频模版资源上传" aria-label="Permalink to &quot;音频模版资源上传&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">include</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Foundation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Cdnable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> upload_source_aliyun</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(url, path)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">StreamingDownloader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.get url</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  StorageManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.upload file, path, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">internal:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cdn_url(path)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 音频模版处理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">urls </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Rails</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache.read(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;saturn:materials:audios:20250304&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).list.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:image_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:audio_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).flatten</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">urls.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |url|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> url.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">gsub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://aejp.bebememo.us/alijp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cn? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;sz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hk&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  upload_source_aliyun url, path</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 音频模版名称替换</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Rails</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache.read(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;saturn:materials:audios:20250304&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data.list.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |audio|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  audio[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:image_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> audio[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:image_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">gsub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://aejp.bebememo.us/alijp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cn? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;sz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hk&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  audio[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:audio_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> audio[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:audio_url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">gsub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://aejp.bebememo.us/alijp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cn? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;sz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hk&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Rails</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cache.write(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;saturn:materials:audios:20250304&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, data)</span></span></code></pre></div><h3 id="生成图片向量" tabindex="-1">生成图片向量 <a class="header-anchor" href="#生成图片向量" aria-label="Permalink to &quot;生成图片向量&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> load_baby_moment_vector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find bid</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        start_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.now.to_i</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.moments.picture_or_video.active.count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        baby.moments.picture_or_video.active.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |moment|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            begin</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                moment.create_moment_vector</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            rescue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> =&gt; e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                moment.create_moment_vector</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            total </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mid: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{moment.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      total: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{total}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      use time: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.now.to_i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start_time}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        end_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.now.to_i</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;------&gt; total use time: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{end_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> start_time}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="删除不使用功能代码" tabindex="-1">删除不使用功能代码 <a class="header-anchor" href="#删除不使用功能代码" aria-label="Permalink to &quot;删除不使用功能代码&quot;">​</a></h2><h3 id="一岁一本-开屏页-dialog-商品运营" tabindex="-1">一岁一本 (开屏页，dialog) 商品运营 <a class="header-anchor" href="#一岁一本-开屏页-dialog-商品运营" aria-label="Permalink to &quot;一岁一本 (开屏页，dialog) 商品运营&quot;">​</a></h3><p>开屏页</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> all</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 133</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ai_entry?</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.shop_entry_enabled(current_user)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 73</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.jp?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 134</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cn? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version_after(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">719</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7700</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 一岁一本开屏页版本控制</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @advertisements </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Advertisement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ids).valid.to_a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version_after(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cn? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 761</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7610</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 一岁一本开屏页</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    advertisements </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.timeline_family_ids).map(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:linked_baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      image </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> get_birthday_book_promotion_poster(current_session, baby, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:setup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image.blank?</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      book_advertisement </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Advertisement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      book_advertisement.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10_001</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      book_advertisement.picture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      book_advertisement.settings </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        path:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        closed:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        duration:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        position:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;screen&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        continuous:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        show_app_info:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      advertisements </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> book_advertisement</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      break</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @advertisements </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Advertisement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ids).valid.to_a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> advertisements</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span></code></pre></div><p>Dialog 弹窗</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> load_dialog</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.minutes.ago</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_relation.family?</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dialogs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # VIP弹框禁掉</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dialogs.push </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DialogManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_upgrade_dialog(version_after(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">370</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">602</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), detect_platform) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> current_user.family_version?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dialogs.push </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DialogManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_baby_vip_dialog(@baby, current_user, current_session) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @baby</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # dialogs.push DialogManager.create_family_upgrade(current_user)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # dialogs.push DialogManager.create_family_downgrade_check(current_user)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # dialogs.push DialogManager.create_baby_summary_dialog(@baby)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dialogs.push </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DialogManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_phone_bind_dialog(current_user, current_session, detect_platform)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # dialogs.push DialogManager.create_baby_presenter_dialog(@baby)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # bug 提示更新</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dialogs.push </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DialogManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_upgrade_dialog_0723 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.cn? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version_after(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">743</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">99_999</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version_before(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">749</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dialogs.push </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DialogManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_upgrade_dialog_0723 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ServerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.jp? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version_after(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7430</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">99_999</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version_before(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7481</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 一岁一本弹窗</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    image </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> get_birthday_book_promotion_poster(current_session, @baby, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:dialog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dialogs.push </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DialogManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_shop_book_tips_dialog(image, @baby, current_user) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> image.present?</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dialogs.compact.first</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span></code></pre></div><h3 id="误删复用-moment-pr" tabindex="-1">误删复用 Moment Pr <a class="header-anchor" href="#误删复用-moment-pr" aria-label="Permalink to &quot;误删复用 Moment Pr&quot;">​</a></h3><p><a href="https://github.com/TimeHut/Saturn/issues/866" target="_blank" rel="noreferrer">https://github.com/TimeHut/Saturn/issues/866</a></p><h2 id="数据相关笔记" tabindex="-1">数据相关笔记 <a class="header-anchor" href="#数据相关笔记" aria-label="Permalink to &quot;数据相关笔记&quot;">​</a></h2><p>bid 539980209 (小宝贝) 2024/01/14 记录 (sidekiq 移动复制报错，资源不存在)</p><p>之前 bid 539980209 (小宝贝) 与 bid 539981153 (芷玄) 在爸爸账号下 uid 540217345 有数据复用，芷玄的 moment 数据在 2023-11-15 被删除了。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">539981153</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">baby.moments.unscope(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">where:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :domain</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">deleted_by:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:deleted_at</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).map(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:to_s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2023-11-15 04:12:35 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:36 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:37 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:38 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:38 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:39 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:40 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:43 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:44 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:45 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:46 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:46 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:47 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:48 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:49 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:50 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:51 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:51 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:52 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:53 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:54 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:55 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:56 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:57 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:57 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:58 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;2023-11-15 04:12:59 UTC&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><p>但是误删除的查询时段 2023-11-29 ~ 2023-12-06。</p><p>所以 baby.moments.unscope(where: :domain).where(active: false, deleted_by: nil).where(deleted_at: start_time..end_time).picture_or_video 查询不出来。</p><p>猜测第一轮删除的时候，没有检查出来复用，不是错误代码造成的。</p><p>分析可能存在数据迁移造成的复用数据不存在的问题</p><p>排查的场景，移动复制 sidekiq 发生报错资源不存在，排查到妈妈账号下的全部孩子并没有相同的资源，所以将这一批 moment 设置为 false</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>&quot;batch_move&quot;, {&quot;user_id&quot;=&gt;538698464, &quot;moment_ids&quot;=&gt;[1097753484374230203, 1090937010867323915, 1090937105948001294, 1090937263418950675, 1090937814152037418, 1090937382931448854, 1090936268848809945, 1090936266399336408, 1090924557848724990, 1090924556280055293, 1090924565591410175, 1090924594339169798, 1090936297252636638, 1090937754290930727, 1090936304538142687, 1090936337757030368, 1090924612223682058, 1090936426877601767, 1090936923437057031, 1090936262448302039, 1090924605999334921, 1090936275396118491, 1090937942900393016, 1090936458171303912, 1090936288805308381, 1090936281565939676, 1090924569135597058, 1090924590111311365, 1090936841383887876, 1090924581798200836, 1090924605034645000, 1090936274284627930, 1090924580607018499, 1090936542309042156, 1090937630194058270, 1097753494612526284, 1097753644424676622, 1097753490015569095, 1097753489612915910, 1090924565683684864, 1090924600446076423, 1090936789559068671, 1090937173040088081, 1090937486673363995, 1097753484009325753, 1097753484470699196, 1097753532877161696], &quot;baby_id&quot;=&gt;539980209, &quot;to_baby_ids&quot;=&gt;[537922407]}</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Event</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.fifafu(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1090924556233917948</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).moments.active.picture_or_video.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |m|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;tencent_gz&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aliyun_de&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(m.service)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">538698464</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  field </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> m[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;video&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (m[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:video_hd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].present? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :video_hd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:video</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) : </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:picture</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  aliyun_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OssManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ObjectProcessor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(m[field]).aliyun_info</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> aliyun_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;not exist&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> check_repeat?(user, m)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mid: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{m.type}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   field: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{field}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   exists: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{exists}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    m.update_columns </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exists</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> check_repeat?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user, moment)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  is_exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user.family_relations.checked.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |fr|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    linked_baby </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fr.with_user.linked_baby</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 539980209</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    linked_baby.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 虽然照片被复用，当全部的复用都经过用户转移操作后，依然删除</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;video&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">video_hd:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.video_hd</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists4 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">taken_at_gmt:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.taken_at_gmt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists4</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;picture&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">picture:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.picture</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">parent_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> linked_baby.moments.exists? </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">taken_at_gmt:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> moment.taken_at_gmt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        is_exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_exists3</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  is_exists</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936262448302039</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936266399336408</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936268848809945</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936274284627930</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936275396118491</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936281565939676</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936288805308381</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936297252636638</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936304538142687</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> picture   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936337757030368</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936426877601767</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936458171303912</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936542309042156</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936789559068671</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936841383887876</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090936923437057031</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937010867323915</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937173040088081</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937263418950675</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937382931448854</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937486673363995</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937630194058270</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937754290930727</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937814152037418</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1090937942900393016</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">field:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> video_hd   </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span></code></pre></div><h2 id="统计数据操作代码块" tabindex="-1">统计数据操作代码块 <a class="header-anchor" href="#统计数据操作代码块" aria-label="Permalink to &quot;统计数据操作代码块&quot;">​</a></h2><h3 id="执行脚本" tabindex="-1">执行脚本 <a class="header-anchor" href="#执行脚本" aria-label="Permalink to &quot;执行脚本&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 拉取小时数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">RealtimeAutomator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.run</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 数据从哪里来，添加新的国家的时候要跑一下</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">task collect_day_data</span></span></code></pre></div><h3 id="刷新-tiktok-token" tabindex="-1">刷新 Tiktok Token <a class="header-anchor" href="#刷新-tiktok-token" aria-label="Permalink to &quot;刷新 Tiktok Token&quot;">​</a></h3><p>1、登录网址</p><p><a href="https://ads.tiktok.com/business/en?tt4b_lang_redirect=1" target="_blank" rel="noreferrer">https://ads.tiktok.com/business/en?tt4b_lang_redirect=1</a></p><p>2、刷新 ads cookie 接口</p><p><a href="https://ads.tiktok.com/api/attrib/trace/init/" target="_blank" rel="noreferrer">https://ads.tiktok.com/api/attrib/trace/init/</a></p><p>3、刷新 csrftoken 接口</p><p>在应用的 Cookie 管理找到 csrftoken</p><h2 id="小屋内部操作代码块" tabindex="-1">小屋内部操作代码块 <a class="header-anchor" href="#小屋内部操作代码块" aria-label="Permalink to &quot;小屋内部操作代码块&quot;">​</a></h2><h3 id="选择-logo-方案" tabindex="-1">选择 LOGO 方案 <a class="header-anchor" href="#选择-logo-方案" aria-label="Permalink to &quot;选择 LOGO 方案&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.hgetall </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;saturn:vote:scene01.zh-CN&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.hgetall </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;saturn:vote:scene01.zh-TW&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.hgetall </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;saturn:vote:scene01.ja&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.hgetall </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;saturn:vote:scene01.ko&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.redis { |r| r.hgetall </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;saturn:vote:scene01.en&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><h3 id="更新-logo-打分统计" tabindex="-1">更新 Logo 打分统计 <a class="header-anchor" href="#更新-logo-打分统计" aria-label="Permalink to &quot;更新 Logo 打分统计&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 国内票数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vote </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |value|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  vote[value.to_s] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Mongodb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vote</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vote02&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value.to_s).count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;(国内) =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> #{vote}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 港台票数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vote </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |value|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  vote[value.to_s] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Mongodb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vote</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;lang&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;$in&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zh-TW&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;zh-CN&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]}).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vote02&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value.to_s).count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;(港台) =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> #{vote}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vote </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |value|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  vote[value.to_s] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Mongodb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vote</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;lang&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;$in&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ja&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ko&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;it&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;en&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]}).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vote02&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">value:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> value.to_s).count</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;(其他) =&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> #{vote}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span></code></pre></div><h3 id="指定国家、时间区间、新用户上传量分析" tabindex="-1">指定国家、时间区间、新用户上传量分析 <a class="header-anchor" href="#指定国家、时间区间、新用户上传量分析" aria-label="Permalink to &quot;指定国家、时间区间、新用户上传量分析&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> upload_volimn_statis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(country, start_time, end_time, source </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;iphone&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  babys </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">country:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> country, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(start_time)..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(end_time)).active.order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :desc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  babys </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> babys.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> source</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby_groups </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> babys.find_each.group_by </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.created_at.strftime(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%Y-%m-%d&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby_groups.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |k, v|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{k}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    v.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |b|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      b.secret_room </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ms </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b.moments.active.picture_or_video</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ms.group(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).count</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{b.id}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> picture: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{count[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;picture&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> video: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{count[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;video&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{b.space_used </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">M&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">upload_volimn_statis </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;IT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2024-03-22 00:00:00&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2024-04-10 23:59:59&quot;</span></span></code></pre></div><h3 id="查询反馈过-1v3-的用户" tabindex="-1">查询反馈过 1v3 的用户 <a class="header-anchor" href="#查询反馈过-1v3-的用户" aria-label="Permalink to &quot;查询反馈过 1v3 的用户&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> one_v_three</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;2023-12-01 00:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uids1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt;= ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(date)).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">content:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;您好，小屋VIP是以孩子為主，1個VIP只能供一個孩子使用哈。&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uids2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt;= ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(date)).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">content:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;您好，1V3是針對老用戶開放的權益，您的賬號只享有1V1的VIP權益的哈，感謝您的理解。&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uids3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt;= ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(date)).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">content:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;抱歉，鑑於目前公司業務長期穩定的發展，2023.12.1日以后不再受理1V1用戶升級1V3的業務了，感謝您的理解。&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (uids1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uids2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uids3).uniq.compact</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ServerConfig</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.cn? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;(国内)&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;(港台)&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">反馈的用户数量&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{date}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&gt;：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{uids.length}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 个&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uids</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> one_v_three</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(date </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;2023-12-01 00:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uids1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt;= ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(date)).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">content:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;您好，小屋VIP是以孩子为主，1个VIP只能供一个孩子使用哈。&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uids2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt;= ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(date)).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">content:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;您好，1V3是针对老用户开放的权益，您的账号只享有1V1的VIP权益的哈，感谢您的理解。&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uids3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;created_at &gt;= ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(date)).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">content:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;抱歉，鉴于目前公司业务长期稳定的发展，2023.12.1日以后不再受理1V1用户升级1V3的业务了，感谢您的理解。&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (uids1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uids2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uids3).uniq.compact</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ServerConfig</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.cn? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;(国内)&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;(港台)&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">反馈的用户数量&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{date}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&gt;：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{uids.length}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 个&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uids</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span></code></pre></div><h3 id="_1v1-买过且有两个孩子的用户-在给第二个孩子购买数量" tabindex="-1">1v1，买过且有两个孩子的用户，在给第二个孩子购买数量 <a class="header-anchor" href="#_1v1-买过且有两个孩子的用户-在给第二个孩子购买数量" aria-label="Permalink to &quot;1v1，买过且有两个孩子的用户，在给第二个孩子购买数量&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buy_vip_users</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      one:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      two:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_vips </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserVip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;v2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2023-06-01 00:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-01-01 00:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">family:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vips.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq.compact</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_ids.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |uid|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      family_relations </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(uid).family_relations.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">relation:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;self&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).active.show</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      with_user_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> family_relations.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:with_user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> family_relations.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vips.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uid).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq.compact</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bids.uniq.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          result[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:two</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].push(uid)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          result[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:one</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].push(uid) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">linked_user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> with_user_ids).any?</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.to_json</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span></code></pre></div><p>新：1v1，买过且有两个孩子的用户，在给第二个孩子购买数量</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buy_vip_user2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 2024-01-01 ~ 2024-02-01 空间已满的孩子</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 1、购买VIP数量</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 1.1 购买VIP当中，购买者是1v1首次购买</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 1.2 购买VIP孩子中，购买者是1v1至少2笔购买</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  start_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-01-01 00:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  end_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-02-01 00:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  time_range </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> start_time..end_time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  babys </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Baby</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time_range).active.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">select</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyPayment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.quiet_perlod(baby)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyPayment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.decline_perlod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.space_used </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.gigabytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby.space_used </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.gigabytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (baby.size_rate </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  babys </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> babys.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">select</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |baby|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby_vip </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyVip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby.id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby_vip.nil? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_vip.created_at </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> end_time</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;空间已满的孩子: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{babys.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby_vips </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BabyVip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> babys.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vip_expiration &gt; ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.now.to_i)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;购买了VIP的孩子数量: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{baby_vips.count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  counts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    a:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    b:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  baby_vips.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |b_vip|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b_vip.last_bought_by</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    user_vips </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserVip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">renew_count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vip_expiration &gt; ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.now.to_i)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vips.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vips.last.baby_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b_vip.baby_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Payment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id).count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vips.last.version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;v2&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      counts[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].push(user_id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vips.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq.compact.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vips.last.version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;v2&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      counts[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].push(user_id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;购买VIP当中，购买者是1v1首次购买的用户: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{counts[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">].count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;购买VIP当中，购买者是1v1至少2笔购买的用户  : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{counts[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">].count}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> counts.to_json</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>方案三 :</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 时间：2023-12-01 ~ 2024-02-01，三个月</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 总数：1v1用户中，至少有2个孩子，且空间都&gt;500M</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># A：自己购买的VIP，且只买过一个</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># B：自己购买的VIP，且买过多个</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> buy_vip_user3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  start_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2023-07-01 00:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  end_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2023-10-01 00:00:00&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  time_range </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> start_time..end_time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    a:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [],</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    b:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  UserVip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time_range, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;v2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">vip_product_type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;yearly&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |user_vip|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    family_relations </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vip.user.family_relations.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">select</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |family_relation|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      family_relation.with_user.is_baby? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mom&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;dad&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].include?(family_relation.peer.relation)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> family_relations.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> family_relations.all? </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |family_relation|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      family_relation.with_user.linked_baby.space_used </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.gigabytes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    next</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Payment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vip.user_id).where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time_range).count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # next if Payment.where(user_id: user_vip.user_id).where.not(&quot;created_at &lt; ?&quot;, start_time).count &gt; 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    payments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Payment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_vip.user_id, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time_range, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">version:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;v2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    baby_ids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> family_relations.map { |family_relation| family_relation.with_user.linked_baby.id }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payments.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> baby_ids.include?(payments.last.baby_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      result[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].push user_vip.user_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payments.count </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payments.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:baby_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).all? { |id| baby_ids.include?(id) }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      result[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].push user_vip.user_id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result.to_json</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span></code></pre></div><h3 id="查询用户反馈量-dongjie" tabindex="-1">查询用户反馈量(DongJie) <a class="header-anchor" href="#查询用户反馈量-dongjie" aria-label="Permalink to &quot;查询用户反馈量(DongJie)&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> feedbacks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lang)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    query </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Feedback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.send_by_user.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lang:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lang, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-01-01 00:00:01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.parse(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2024-05-01 00:00:01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    query </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;content not like ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%[Delete Account]%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    query </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;content not like ?&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%【Ignore】%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    query </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query.where.not(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;content is null&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    query </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> query.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;reply_to is null or reply_to != &#39;h3c@shiguangxiaowu.cn&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # query.each do |f|</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   puts &quot;#{f.id} #{f.content}&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # puts query.pluck(:user_id).uniq.compact.to_s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    query.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).uniq.compact.length</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="ai-数字头像" tabindex="-1">AI 数字头像 <a class="header-anchor" href="#ai-数字头像" aria-label="Permalink to &quot;AI 数字头像&quot;">​</a></h2><p>测试账号：<br><a href="https://admin.shiguangxiaowu.cn/new_feedbacks/userInfo/userInfoDetail?userId=6859228" target="_blank" rel="noreferrer">https://admin.shiguangxiaowu.cn/new_feedbacks/userInfo/userInfoDetail?userId=6859228</a></p><h2 id="替换素材" tabindex="-1">替换素材 <a class="header-anchor" href="#替换素材" aria-label="Permalink to &quot;替换素材&quot;">​</a></h2><h3 id="替换-日记-与-标签-新手引导视频素材" tabindex="-1">替换”日记“与”标签“新手引导视频素材 <a class="header-anchor" href="#替换-日记-与-标签-新手引导视频素材" aria-label="Permalink to &quot;替换”日记“与”标签“新手引导视频素材&quot;">​</a></h3><p>日记位置: app/helpers/moments_helper.rb -&gt; guide_video<br> 标签位于: 国际化文件 controller -&gt; guidance.tag.video_url</p><h2 id="用户操作记录" tabindex="-1">用户操作记录 <a class="header-anchor" href="#用户操作记录" aria-label="Permalink to &quot;用户操作记录&quot;">​</a></h2><h3 id="合并标签记录-bid-538220528" tabindex="-1">合并标签记录 (bid: 538220528) <a class="header-anchor" href="#合并标签记录-bid-538220528" aria-label="Permalink to &quot;合并标签记录 (bid: 538220528)&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">irb(main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">050&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TaggingRecord.where(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 616061</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, baby_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">538220528</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).active.count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">121</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">irb(main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">051&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TaggingRecord.where(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 616066</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, baby_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">538220528</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).active.count</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">77</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">irb(main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):052</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TaggingRecord.where(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 616066</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, baby_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">538220528</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).active.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">irb(main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):053</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   puts </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;tagging_record_id: #{t.id}&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">irb(main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):054</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   t.update</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 616061</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">irb(main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">055&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709720991285493</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709721465241849</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709721637208316</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709732194271489</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709733318344965</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709733846827273</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709740452856077</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709742738751761</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709743581806869</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709748774355225</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709751127359773</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709751358046497</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709757070688549</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709759364972841</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709760203833645</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709764683350321</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709768164622645</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709768353366328</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709774196031805</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709778713297224</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709778897846603</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709783465443670</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709783528358231</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709788259533155</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709788456665446</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709792210567535</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709792281870704</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709796622975348</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709797587665277</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709800796307843</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709805779141006</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709805988856209</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709809394631066</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709816432673187</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709816940183975</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709819528069547</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709824217301423</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709825995686323</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709826750661047</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709842420580795</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709847743152575</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709848674288067</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709873659756999</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709879082992076</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709883826749904</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709905083482586</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709914893959655</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709917670588909</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709925862064625</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709927925662197</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709931776033273</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709947286569469</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709953640940033</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709960502821381</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709963984093705</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709972242678285</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709974675374609</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709980442542613</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709987069542937</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709988990534173</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349709994950640161</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710001955127845</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710002479415849</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710009567789613</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710014529651249</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710018430353973</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710023782285881</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710034700059197</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710050470642241</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710060339839557</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710066442551881</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710074910851661</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710075401585233</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710084733911637</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710094695383641</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710112911245917</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tagging_record_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1349710116535124577</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nil</span></span></code></pre></div><p>2024/08/21 (菱菱 ✨)</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 538000704</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1527339</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1338230694812385551</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1304593210530661248</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1304593212543927170</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1304593216117474180</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475126753263909</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475127021699367</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475127147528489</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475129739608363</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475129831883054</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475129861243183</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475132772090162</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475132826616115</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475133862609205</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475135183814967</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475136026870073</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475137385824572</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1318475137436156221</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1321314868817625330</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1270285377962311750</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1257276970921689176</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1257276971026546777</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1257276971282399323</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1257276973765427293</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1257276973996114015</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1257276974444904545</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1257276980887355491</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1257276982921592933</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1237717529218057005</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1396741240079319903</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1396741250166621047</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082372241916734</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082373168857922</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082378986357574</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082380706022217</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082382073365325</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082331586528018</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082331674608406</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1401649724247835024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1401649724461744531</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1401649724717597078</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082331737522967</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082338297414426</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082340105159454</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082340558144290</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082344349795110</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082384397009745</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082346514055978</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082349076775726</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082350377009970</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082353015227190</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1402082354424513338</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1407286007133438396</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1407286006323937718</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1407286006630121913</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">044</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TaggingRecord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">baby_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 538000704</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1527339</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |t|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">045</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   t.update! </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">moment_tag_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1465183</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">046</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span></code></pre></div><h3 id="momentupdateagesworker-没有延时-导致的-total-days-错误问题" tabindex="-1">MomentUpdateAgesWorker 没有延时，导致的 total_days 错误问题 <a class="header-anchor" href="#momentupdateagesworker-没有延时-导致的-total-days-错误问题" aria-label="Permalink to &quot;MomentUpdateAgesWorker 没有延时，导致的 total_days 错误问题&quot;">​</a></h3><p>受到影响的孩子 ID</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>6107596</span></span>
<span class="line"><span>6230703</span></span>
<span class="line"><span>6367702</span></span>
<span class="line"><span>6305518</span></span>
<span class="line"><span>6173192</span></span>
<span class="line"><span>6314893</span></span>
<span class="line"><span>6281338</span></span>
<span class="line"><span>6284796</span></span>
<span class="line"><span>6308432</span></span>
<span class="line"><span>6255914</span></span>
<span class="line"><span>6138092</span></span>
<span class="line"><span>6213106</span></span>
<span class="line"><span>6309305</span></span>
<span class="line"><span>6243998</span></span>
<span class="line"><span>6310752</span></span>
<span class="line"><span>6237189</span></span>
<span class="line"><span>6231089</span></span>
<span class="line"><span>6236447</span></span>
<span class="line"><span>6288254</span></span>
<span class="line"><span>6224878</span></span>
<span class="line"><span>6200890</span></span>
<span class="line"><span>6277221</span></span>
<span class="line"><span>6345089</span></span>
<span class="line"><span>6340098</span></span>
<span class="line"><span>4306576</span></span>
<span class="line"><span>6311121</span></span>
<span class="line"><span>6234380</span></span>
<span class="line"><span>6195499</span></span>
<span class="line"><span>6311901</span></span>
<span class="line"><span>6263020</span></span>
<span class="line"><span>6216013</span></span>
<span class="line"><span>6348918</span></span>
<span class="line"><span>6348961</span></span>
<span class="line"><span>6308671</span></span>
<span class="line"><span>6314815</span></span>
<span class="line"><span>6288763</span></span>
<span class="line"><span>6285020</span></span>
<span class="line"><span>6242702</span></span>
<span class="line"><span>6230454</span></span>
<span class="line"><span>6194605</span></span>
<span class="line"><span>6278423</span></span>
<span class="line"><span>6316323</span></span>
<span class="line"><span>6130137</span></span>
<span class="line"><span>6202508</span></span>
<span class="line"><span>6318118</span></span>
<span class="line"><span>6301058</span></span>
<span class="line"><span>6296735</span></span>
<span class="line"><span>6210344</span></span>
<span class="line"><span>6210884</span></span>
<span class="line"><span>6240983</span></span>
<span class="line"><span>6249397</span></span>
<span class="line"><span>6279622</span></span>
<span class="line"><span>6330053</span></span>
<span class="line"><span>6302271</span></span>
<span class="line"><span>6307041</span></span>
<span class="line"><span>6345087</span></span>
<span class="line"><span>6282588</span></span>
<span class="line"><span>6296728</span></span>
<span class="line"><span>6276091</span></span>
<span class="line"><span>6212605</span></span>
<span class="line"><span>5833788</span></span>
<span class="line"><span>6209079</span></span>
<span class="line"><span>6099787</span></span>
<span class="line"><span>6298959</span></span>
<span class="line"><span>6203904</span></span>
<span class="line"><span>6211631</span></span>
<span class="line"><span>6292397</span></span>
<span class="line"><span>6326421</span></span>
<span class="line"><span>6080379</span></span>
<span class="line"><span>6183784</span></span>
<span class="line"><span>6238042</span></span>
<span class="line"><span>6327143</span></span>
<span class="line"><span>6268437</span></span>
<span class="line"><span>6274634</span></span>
<span class="line"><span>6273835</span></span>
<span class="line"><span>6162536</span></span>
<span class="line"><span>6248645</span></span>
<span class="line"><span>6306744</span></span>
<span class="line"><span>6263061</span></span>
<span class="line"><span>6302581</span></span>
<span class="line"><span>6339748</span></span>
<span class="line"><span>6227863</span></span>
<span class="line"><span>6208660</span></span>
<span class="line"><span>6247155</span></span>
<span class="line"><span>国内iOS、baby_id</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>540613571</span></span>
<span class="line"><span>540535019</span></span>
<span class="line"><span>540635800</span></span>
<span class="line"><span>540465008</span></span>
<span class="line"><span>540384116</span></span>
<span class="line"><span>540436945</span></span>
<span class="line"><span>540636543</span></span>
<span class="line"><span>540641090</span></span>
<span class="line"><span>540476351</span></span>
<span class="line"><span>540464160</span></span>
<span class="line"><span>540596213</span></span>
<span class="line"><span>540619401</span></span>
<span class="line"><span>540565727</span></span>
<span class="line"><span>540430500</span></span>
<span class="line"><span>540655934</span></span>
<span class="line"><span>540659411</span></span>
<span class="line"><span>540659914</span></span>
<span class="line"><span>540635602</span></span>
<span class="line"><span>540641965</span></span>
<span class="line"><span>540635235</span></span>
<span class="line"><span>540694520</span></span>
<span class="line"><span>540620233</span></span>
<span class="line"><span>540602926</span></span>
<span class="line"><span>540507685</span></span>
<span class="line"><span>540475808</span></span>
<span class="line"><span>540619006</span></span>
<span class="line"><span>540531961</span></span>
<span class="line"><span>540463808</span></span>
<span class="line"><span>540621854</span></span>
<span class="line"><span>540487636</span></span>
<span class="line"><span>540607825</span></span>
<span class="line"><span>540572330</span></span>
<span class="line"><span>540396813</span></span>
<span class="line"><span>540564894</span></span>
<span class="line"><span>540622504</span></span>
<span class="line"><span>540389003</span></span>
<span class="line"><span>540496705</span></span>
<span class="line"><span>540619306</span></span>
<span class="line"><span>540635665</span></span>
<span class="line"><span>538100030</span></span>
<span class="line"><span>540429809</span></span>
<span class="line"><span>540661108</span></span>
<span class="line"><span>540307478</span></span>
<span class="line"><span>540451417</span></span>
<span class="line"><span>540432374</span></span>
<span class="line"><span>540552133</span></span>
<span class="line"><span>540445437</span></span>
<span class="line"><span>540583286</span></span>
<span class="line"><span>540629902</span></span>
<span class="line"><span>540596763</span></span>
<span class="line"><span>540459325</span></span>
<span class="line"><span>540443601</span></span>
<span class="line"><span>537400740</span></span>
<span class="line"><span>540688151</span></span>
<span class="line"><span>540683562</span></span>
<span class="line"><span>540684822</span></span>
<span class="line"><span>540593027</span></span>
<span class="line"><span>540512641</span></span>
<span class="line"><span>540403277</span></span>
<span class="line"><span>540663555</span></span>
<span class="line"><span>540664073</span></span>
<span class="line"><span>540587326</span></span>
<span class="line"><span>540418687</span></span>
<span class="line"><span>540600833</span></span>
<span class="line"><span>540327287</span></span>
<span class="line"><span>540458273</span></span>
<span class="line"><span>540430283</span></span>
<span class="line"><span>540554033</span></span>
<span class="line"><span>540464814</span></span>
<span class="line"><span>540658017</span></span>
<span class="line"><span>540402627</span></span>
<span class="line"><span>540402625</span></span>
<span class="line"><span>540635334</span></span>
<span class="line"><span>540631470</span></span>
<span class="line"><span>540658285</span></span>
<span class="line"><span>540608348</span></span>
<span class="line"><span>540676801</span></span>
<span class="line"><span>540506510</span></span>
<span class="line"><span>540647103</span></span>
<span class="line"><span>540638659</span></span>
<span class="line"><span>540647277</span></span>
<span class="line"><span>540333718</span></span>
<span class="line"><span>540287023</span></span>
<span class="line"><span>540600215</span></span>
<span class="line"><span>540475901</span></span>
<span class="line"><span>540602424</span></span>
<span class="line"><span>540647677</span></span>
<span class="line"><span>540465543</span></span>
<span class="line"><span>540600741</span></span>
<span class="line"><span>540456215</span></span>
<span class="line"><span>540509429</span></span>
<span class="line"><span>540647791</span></span>
<span class="line"><span>540586997</span></span>
<span class="line"><span>540650094</span></span>
<span class="line"><span>540650356</span></span>
<span class="line"><span>540530298</span></span>
<span class="line"><span>540388023</span></span>
<span class="line"><span>540656211</span></span>
<span class="line"><span>540519943</span></span>
<span class="line"><span>540549648</span></span>
<span class="line"><span>540510175</span></span>
<span class="line"><span>540440635</span></span>
<span class="line"><span>540557564</span></span>
<span class="line"><span>540622278</span></span>
<span class="line"><span>540475218</span></span>
<span class="line"><span>540663298</span></span>
<span class="line"><span>540669446</span></span>
<span class="line"><span>540495928</span></span>
<span class="line"><span>540520261</span></span>
<span class="line"><span>540196189</span></span>
<span class="line"><span>540171489</span></span>
<span class="line"><span>540429000</span></span>
<span class="line"><span>540452022</span></span>
<span class="line"><span>540482359</span></span>
<span class="line"><span>540437633</span></span>
<span class="line"><span>540629589</span></span>
<span class="line"><span>540629634</span></span>
<span class="line"><span>540576685</span></span>
<span class="line"><span>540518811</span></span>
<span class="line"><span>540478739</span></span>
<span class="line"><span>539719184</span></span>
<span class="line"><span>540654171</span></span>
<span class="line"><span>540630883</span></span>
<span class="line"><span>540374473</span></span>
<span class="line"><span>540511101</span></span>
<span class="line"><span>540399446</span></span>
<span class="line"><span>540571020</span></span>
<span class="line"><span>540590094</span></span>
<span class="line"><span>540630206</span></span>
<span class="line"><span>540556782</span></span>
<span class="line"><span>540518750</span></span>
<span class="line"><span>540602896</span></span>
<span class="line"><span>540634681</span></span>
<span class="line"><span>540635419</span></span>
<span class="line"><span>540651127</span></span>
<span class="line"><span>540133765</span></span>
<span class="line"><span>539261161</span></span>
<span class="line"><span>540465627</span></span>
<span class="line"><span>540582737</span></span>
<span class="line"><span>540587462</span></span>
<span class="line"><span>540511140</span></span>
<span class="line"><span>540504716</span></span>
<span class="line"><span>540477463</span></span>
<span class="line"><span>540580974</span></span>
<span class="line"><span>540668605</span></span>
<span class="line"><span>540414216</span></span>
<span class="line"><span>540668503</span></span>
<span class="line"><span>540523368</span></span>
<span class="line"><span>540043524</span></span>
<span class="line"><span>540656336</span></span>
<span class="line"><span>540660307</span></span>
<span class="line"><span>540519800</span></span>
<span class="line"><span>540584834</span></span>
<span class="line"><span>540538210</span></span>
<span class="line"><span>540488101</span></span>
<span class="line"><span>540466316</span></span>
<span class="line"><span>540507249</span></span>
<span class="line"><span>540617183</span></span>
<span class="line"><span>540644585</span></span>
<span class="line"><span>540571031</span></span>
<span class="line"><span>540521367</span></span>
<span class="line"><span>540669286</span></span>
<span class="line"><span>540494671</span></span>
<span class="line"><span>537149776</span></span>
<span class="line"><span>540604521</span></span>
<span class="line"><span>540678204</span></span>
<span class="line"><span>540464532</span></span>
<span class="line"><span>540503049</span></span>
<span class="line"><span>540623382</span></span>
<span class="line"><span>540458526</span></span>
<span class="line"><span>540503150</span></span>
<span class="line"><span>540580376</span></span>
<span class="line"><span>540609901</span></span>
<span class="line"><span>540440431</span></span>
<span class="line"><span>540501778</span></span>
<span class="line"><span>540241463</span></span>
<span class="line"><span>540643032</span></span>
<span class="line"><span>540580624</span></span>
<span class="line"><span>540271384</span></span>
<span class="line"><span>540557882</span></span>
<span class="line"><span>540538398</span></span>
<span class="line"><span>540435523</span></span>
<span class="line"><span>540531611</span></span>
<span class="line"><span>540636435</span></span>
<span class="line"><span>540462650</span></span>
<span class="line"><span>540277162</span></span>
<span class="line"><span>540439513</span></span>
<span class="line"><span>540474507</span></span>
<span class="line"><span>540572935</span></span>
<span class="line"><span>540503475</span></span>
<span class="line"><span>540553803</span></span>
<span class="line"><span>540674302</span></span>
<span class="line"><span>540682299</span></span>
<span class="line"><span>540641280</span></span>
<span class="line"><span>540579914</span></span>
<span class="line"><span>538085009</span></span>
<span class="line"><span>540683313</span></span>
<span class="line"><span>540414356</span></span>
<span class="line"><span>540518413</span></span>
<span class="line"><span>540636320</span></span>
<span class="line"><span>540683965</span></span>
<span class="line"><span>537190891</span></span>
<span class="line"><span>540576163</span></span>
<span class="line"><span>540548605</span></span>
<span class="line"><span>540684265</span></span>
<span class="line"><span>540647685</span></span>
<span class="line"><span>540677510</span></span>
<span class="line"><span>540540817</span></span>
<span class="line"><span>540634003</span></span>
<span class="line"><span>540682864</span></span>
<span class="line"><span>540682906</span></span>
<span class="line"><span>540601498</span></span>
<span class="line"><span>540631079</span></span>
<span class="line"><span>540685135</span></span>
<span class="line"><span>540452431</span></span>
<span class="line"><span>540633389</span></span>
<span class="line"><span>540533838</span></span>
<span class="line"><span>540471751</span></span>
<span class="line"><span>540621959</span></span>
<span class="line"><span>540424099</span></span>
<span class="line"><span>540465782</span></span>
<span class="line"><span>540620442</span></span>
<span class="line"><span>540684660</span></span>
<span class="line"><span>540685766</span></span>
<span class="line"><span>540188290</span></span>
<span class="line"><span>540509300</span></span>
<span class="line"><span>540484496</span></span>
<span class="line"><span>540477400</span></span>
<span class="line"><span>540435876</span></span>
<span class="line"><span>540492820</span></span>
<span class="line"><span>540483423</span></span>
<span class="line"><span>540688768</span></span>
<span class="line"><span>540657311</span></span>
<span class="line"><span>540568440</span></span>
<span class="line"><span>540427358</span></span>
<span class="line"><span>540530527</span></span>
<span class="line"><span>540520975</span></span>
<span class="line"><span>540458724</span></span>
<span class="line"><span>540687989</span></span>
<span class="line"><span>540623704</span></span>
<span class="line"><span>540621086</span></span>
<span class="line"><span>540689463</span></span>
<span class="line"><span>540511074</span></span>
<span class="line"><span>540690202</span></span>
<span class="line"><span>540628648</span></span>
<span class="line"><span>540328092</span></span>
<span class="line"><span>540603502</span></span>
<span class="line"><span>540619426</span></span>
<span class="line"><span>540640218</span></span>
<span class="line"><span>540629451</span></span>
<span class="line"><span>540502023</span></span>
<span class="line"><span>540691262</span></span>
<span class="line"><span>540510352</span></span>
<span class="line"><span>540095862</span></span>
<span class="line"><span>540536392</span></span>
<span class="line"><span>540691543</span></span>
<span class="line"><span>539423810</span></span>
<span class="line"><span>540653646</span></span>
<span class="line"><span>540625107</span></span>
<span class="line"><span>540640537</span></span>
<span class="line"><span>540634440</span></span>
<span class="line"><span>540482328</span></span>
<span class="line"><span>540662666</span></span>
<span class="line"><span>540479795</span></span>
<span class="line"><span>540255541</span></span>
<span class="line"><span>540641259</span></span>
<span class="line"><span>540599261</span></span>
<span class="line"><span>540641407</span></span>
<span class="line"><span>540640737</span></span>
<span class="line"><span>540443817</span></span>
<span class="line"><span>540589591</span></span>
<span class="line"><span>540482153</span></span>
<span class="line"><span>540434699</span></span>
<span class="line"><span>540616986</span></span>
<span class="line"><span>540438075</span></span>
<span class="line"><span>540487896</span></span>
<span class="line"><span>540642705</span></span>
<span class="line"><span>540439170</span></span>
<span class="line"><span>540453785</span></span>
<span class="line"><span>540591418</span></span>
<span class="line"><span>540424046</span></span>
<span class="line"><span>540597408</span></span>
<span class="line"><span>540501690</span></span>
<span class="line"><span>540141498</span></span>
<span class="line"><span>540491821</span></span>
<span class="line"><span>540642381</span></span>
<span class="line"><span>540524749</span></span>
<span class="line"><span>540636907</span></span>
<span class="line"><span>540488666</span></span>
<span class="line"><span>540541963</span></span>
<span class="line"><span>540647609</span></span>
<span class="line"><span>540562241</span></span>
<span class="line"><span>540427000</span></span>
<span class="line"><span>540569775</span></span>
<span class="line"><span>540537031</span></span>
<span class="line"><span>540491284</span></span>
<span class="line"><span>540362139</span></span>
<span class="line"><span>540499872</span></span>
<span class="line"><span>540551570</span></span>
<span class="line"><span>540621428</span></span>
<span class="line"><span>540514891</span></span>
<span class="line"><span>540643378</span></span>
<span class="line"><span>540548268</span></span>
<span class="line"><span>540517646</span></span>
<span class="line"><span>540506061</span></span>
<span class="line"><span>540425286</span></span>
<span class="line"><span>540652529</span></span>
<span class="line"><span>540653179</span></span>
<span class="line"><span>540271604</span></span>
<span class="line"><span>540655138</span></span>
<span class="line"><span>540487268</span></span>
<span class="line"><span>538825499</span></span>
<span class="line"><span>540451451</span></span>
<span class="line"><span>港台iOS</span></span></code></pre></div><p>修复方式：重新放入到异步任务中更新</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bids </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bids.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |bid|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    MomentUpdateAgesWorker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.perform_async bid.to_i</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{bid}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="_20250224-checkcoverworker-任务失败-数据处理" tabindex="-1">20250224 CheckCoverWorker 任务失败(数据处理) <a class="header-anchor" href="#_20250224-checkcoverworker-任务失败-数据处理" aria-label="Permalink to &quot;20250224 CheckCoverWorker 任务失败(数据处理)&quot;">​</a></h3><p>查询到 bid: 554643 名称: Belle, 在制作相册的任务中，这些 moment 宽高都是 0，则会去修复宽高逻辑，但是报错了。把这些 moment (都是 290 这一天 web 上传的) 下载下来都是文件损坏的，则将这些 moment active 设置为 false。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>&quot;[243897409469042659, 243897162307096531, 243897092610346958, 243897534572548076, 243897235875188696, 243897322131050462, 243897528515973099, 243897467740508135, 243897177779883988, 243897228224778199, 243897279118462939, 243897293400068060, 243897269031161818, 243897545876197357, 243897205147717590, 243897355760979935, 243897512980271082, 243897454071271398, 243897500623851497, 243897123253931984, 243897147731890130, 243897379802730465, 243897438355214309, 243897563991396334, 243897396319899618, 243897482990997480, 243897137917218769, 243897192032128981, 243897424312684516, 243897075539529677, 243897315072036829, 243897108565479375, 243897251654160345, 243897365143637984]&quot;</span></span></code></pre></div><h3 id="_20250415-错误头像数据修复" tabindex="-1">20250415 错误头像数据修复 <a class="header-anchor" href="#_20250415-错误头像数据修复" aria-label="Permalink to &quot;20250415 错误头像数据修复&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">irb(main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">006&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users.pluck(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:id,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :profile_picture</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3651803</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552913586297.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3633541</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552473443497.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3633954</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552480024999.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3650485</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552892247410.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3628226</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552364957317.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3628789</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552376171039.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3050815</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1550153616608.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3628185</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552363581444.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3654200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552980179649.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3600231</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1551753994403.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3570855</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1551092953129.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3628179</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552363382075.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3649980</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552890828443.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3650564</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552893197969.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3650656</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552895626210.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3637311</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552563127072.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3637833</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552572216788.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3638969</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552618160306.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3639150</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552620364945.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3639252</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552621455479.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3639335</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552622376116.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3640200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1551592058179.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3653150</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552961928696.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3617548</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552276819967.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3569173</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1551064069475.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3648133</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552822937003.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3631426</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552442775264.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3631546</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552445544972.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3631684</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552447333461.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3631864</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552450973932.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3650643</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/storage/emulated/0/Android/data/com.liveyap.timehut/cache/CLIP_1552895402458.jpg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]]</span></span></code></pre></div><h2 id="ios-版本发布修复的问题" tabindex="-1">IOS 版本发布修复的问题 <a class="header-anchor" href="#ios-版本发布修复的问题" aria-label="Permalink to &quot;IOS 版本发布修复的问题&quot;">​</a></h2><h3 id="_7730" tabindex="-1">7730 <a class="header-anchor" href="#_7730" aria-label="Permalink to &quot;7730&quot;">​</a></h3><p>ios 修复 /zh-CN/tagging_records/batches 接口，参数标签 tag [] 没有传的问题，导致服务端报错</p><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>  &quot;undefined method `[]&#39; for nil:NilClass&quot;</span></span></code></pre></div><p>timehut_one 描述: ios 客户端 tag 参数为传，修复版本 7730 用户版本 7180</p><h2 id="代办事项" tabindex="-1">代办事项 <a class="header-anchor" href="#代办事项" aria-label="Permalink to &quot;代办事项&quot;">​</a></h2><h3 id="_2024-08-06-2024-08-09" tabindex="-1">2024-08-06 / 2024-08-09 <a class="header-anchor" href="#_2024-08-06-2024-08-09" aria-label="Permalink to &quot;2024-08-06 / 2024-08-09&quot;">​</a></h3><p>✅ 给用户按季备份 <a href="https://admin.peekaboomoments.com/new_feedbacks/feedbacks/reply?workOrder=537109858" target="_blank" rel="noreferrer">时光小屋后台管理系统</a></p><p>✅ 清理 sidekiq MomentFacesWorker 的报错</p><p>✅ 处理 timehut.one 生日本报错</p><p>✅ 给用户合并标签，Line 反馈 uid: 538708418</p><p>❌ 后台添加按天查询待续费的孩子</p><p>需求文档：<a href="https://bithouse.feishu.cn/docx/Wn3OdTQZao0davxABh0cl5G1nih?source_type=message&amp;from=message#IzHKdNwAxopVhqxf0rrczoejn5c" target="_blank" rel="noreferrer">https://bithouse.feishu.cn/docx/Wn3OdTQZao0davxABh0cl5G1nih?source_type=message&amp;from=message#IzHKdNwAxopVhqxf0rrczoejn5c </a><br> 原型图：<a href="https://applink.feishu.cn/client/message/link/open?token=AmGbXt7ORUAcZrHur0FLQBw%3D" target="_blank" rel="noreferrer">https://applink.feishu.cn/client/message/link/open?token=AmGbXt7ORUAcZrHur0FLQBw%3D</a></p><h3 id="_2024-08-12-2024-08-16" tabindex="-1">2024-08-12 / 2024-08-16 <a class="header-anchor" href="#_2024-08-12-2024-08-16" aria-label="Permalink to &quot;2024-08-12 / 2024-08-16&quot;">​</a></h3><p>✅ 删除 moment faces 统计 baby_id 的 redis key</p><p>🔳 baby_moments_score ，现在提早到 23 年 9 月 1 日后注册的，还没有跑完，量太大，后面还要接着跑</p><p>✅ 后台将新标签关联到快捷回复</p><h3 id="_2024-09-06" tabindex="-1">2024-09-06 <a class="header-anchor" href="#_2024-09-06" aria-label="Permalink to &quot;2024-09-06&quot;">​</a></h3><p>ES 旧数据迁移</p><p><strong>国内 ：</strong> indexer_migrate <strong><u>12,032,823</u></strong> (event)</p><p><strong>港台 ：</strong> indexer_migrate <strong><u>22,274,165</u></strong> (event)</p><h3 id="_2025-02-24-2025-02-28" tabindex="-1">2025-02-24 / 2025-02-28 <a class="header-anchor" href="#_2025-02-24-2025-02-28" aria-label="Permalink to &quot;2025-02-24 / 2025-02-28&quot;">​</a></h3><div class="mermaid">null</div></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-b77f9094><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"document_develop_ui设计.md\":\"DE-yLaVr\",\"document_develop_ui_设计资料笔记.md\":\"BJz4dnyL\",\"document_develop_海外支付.md\":\"CdeGDXE5\",\"document_index.md\":\"DpOKmwDd\",\"document_develop_app_index.md\":\"B8jEN633\",\"document_develop_寻找远程开发工作.md\":\"rNITyeDi\",\"document_english_index.md\":\"CyETCrwY\",\"document_develop_简历_index.md\":\"BnEcHwBK\",\"document_develop_英语笔记_index.md\":\"CodSK1P8\",\"document_develop_英语笔记_语法1.md\":\"CTuqBVVi\",\"document_develop_简历_在线简历.md\":\"D_uWZVZF\",\"api-examples.md\":\"B-krwVNx\",\"document_develop_简历_项目截图.md\":\"Eq_nBRo7\",\"document_services_index.md\":\"CeNy2TfG\",\"document_develop_广告对接.md\":\"m5QcwATF\",\"document_english_语法.md\":\"iULUwnNo\",\"readme.md\":\"DJabgjMA\",\"document_develop_ui_index.md\":\"DUzHNpl6\",\"document_develop_独立开发应用部署.md\":\"BqSsWQkB\",\"document_develop_seo.md\":\"CJeGlgqP\",\"document_services_golang_index.md\":\"DkGNVlmn\",\"document_develop_index.md\":\"Bwwqp5iq\",\"document_develop_ui_ux设计笔记.md\":\"aGtFVKSn\",\"document_develop_app_优睡眠.md\":\"DkRjJ03_\",\"document_services_linux_docker容器引擎.md\":\"6QrVHXoH\",\"document_services_linux_git版本管理工具.md\":\"CoW1cGK_\",\"document_services_linux_linux系统配置文件.md\":\"DdMgrhSN\",\"document_services_linux_linux基础命令.md\":\"tj5o6KvL\",\"document_services_linux_elasticsearch数据库操作.md\":\"brAeAw4m\",\"document_services_linux_linux文本编辑工具.md\":\"BUrP7KpV\",\"document_services_golang_golang 基础编程.md\":\"BejwDodn\",\"document_services_node_index.md\":\"rj7FL1bO\",\"document_services_python_fastapi_fastapi 安装与配置.md\":\"NI2zu4wu\",\"document_services_linux_linux运维常见场景操作.md\":\"BunQeVrG\",\"document_services_node_nestjs_nestjs 安装与配置.md\":\"Uyf_TvRt\",\"document_services_python_index.md\":\"iFWrfPXB\",\"document_services_linux_index.md\":\"CDPKgCmY\",\"document_services_node_版本管理工具.md\":\"DdX5evLO\",\"document_services_linux_shell命令脚本.md\":\"Di-SmOpt\",\"document_services_linux_redis数据库操作.md\":\"D8Yu90zK\",\"document_services_python_语法基础.md\":\"BYg84qyh\",\"document_services_python_版本管理工具.md\":\"qHzaHocc\",\"document_services_linux_ngnix代理服务器.md\":\"DPuIo2R-\",\"document_services_ruby_index.md\":\"Cx5X0rV2\",\"document_services_ruby_ruby 基础.md\":\"DQEebEOd\",\"document_services_ruby_rails_rails mailer 发送邮件.md\":\"KOX3ZQ8D\",\"document_services_ruby_rails_rails cache 缓存.md\":\"BuV0WYLC\",\"document_services_ruby_rails_rails controller 控制器.md\":\"eCUf8f4n\",\"document_services_ruby_rails_rails setting 约定配置.md\":\"DA0BDNHM\",\"document_services_ruby_rails_rails routing 路由器.md\":\"H5YMPqy0\",\"document_services_ruby_rails_rails session、cookie、token 凭证及数据闪存.md\":\"D4UGslZN\",\"document_services_ruby_rails_rails 安装与配置.md\":\"BhTcR4rt\",\"document_services_ruby_rails_rails 集成 sidekiq 队列.md\":\"BZ4r2j0p\",\"document_services_ruby_rails_rails view 视图层.md\":\"CoSY9ITE\",\"document_services_ruby_rails_rails 集成 whenever 定时任务.md\":\"sEfIeaqJ\",\"document_views_flutter_pubspec配置.md\":\"Bt3ZVYHw\",\"document_views_flutter_index.md\":\"BtAe9AKB\",\"document_services_ruby_安装.md\":\"DbuCsGMq\",\"document_views_flutter_dart语言基础.md\":\"BOD5Cvpc\",\"document_views_flutter_安装.md\":\"BS6lsrBx\",\"document_views_flutter_状态管理.md\":\"B0mBHj5v\",\"document_services_ruby_rails_rails model 数据模型层.md\":\"BKIrFEWb\",\"document_views_flutter_widget component 组件、控件.md\":\"BXSH0eUO\",\"document_views_flutter_路由管理.md\":\"Cs9Pb1in\",\"document_views_index.md\":\"mX6jNIFZ\",\"document_views_vue_index.md\":\"D-6478co\",\"document_views_前端常用代码段.md\":\"CBP318f9\",\"document_workers_index.md\":\"Dp67lAju\",\"document_views_vue_vue报错总结归纳.md\":\"fB2h2D_u\",\"document_workers_timehut_商城业务文档.md\":\"BNKrhXTz\",\"document_workers_timehut_index.md\":\"COz9Q_eu\",\"document_workers_timehut_bebememo 服务管理.md\":\"Bxqyzt50\",\"document_workers_timehut_商城任务文档.md\":\"DyTpezFo\",\"document_workers_timehut_商城技术文档.md\":\"BSEAq0r5\",\"notes_20250226_10_28.md\":\"CmiMUKK_\",\"document_workers_timehut_接口文档.md\":\"DW4Py8qG\",\"document_views_flutter_语法基础与常用组件.md\":\"BMp2uGrV\",\"material_02f842eb-8e89-4910-a241-8af9d74085bf.md\":\"DRLyoErb\",\"notes_20250228_15_10.md\":\"54Lalt8F\",\"index.md\":\"siGcMBm4\",\"markdown.md\":\"61FJ6Mmh\",\"document_workers_timehut_数据库表.md\":\"DkNNerUd\",\"markdown-examples.md\":\"BMaXIzlC\",\"notes_20250310_14_24.md\":\"B_LW4jCS\",\"notes_20250303_17_48.md\":\"cHUcxJkW\",\"notes_20250402_16_52.md\":\"_CWx_Ppy\",\"notes_20250402_18_35.md\":\"BGnmnWaj\",\"notes_20250325_09_51.md\":\"Cng2qjGF\",\"document_workers_timehut_小屋服务启动管理.md\":\"1Qp2eL3p\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"VitePress\",\"description\":\"bolg ...\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"siteTitle\":\"Zouzhu's Wiki\",\"search\":{\"provider\":\"local\"},\"outline\":{\"label\":\"目录大纲\",\"level\":\"deep\"},\"nav\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"联系我\",\"link\":\"mailto:zouzhuqorg@gmail.com\"}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/zouzhu-code-89\"},{\"icon\":\"twitter\",\"link\":\"...\"}],\"blogs\":[{\"title\":\"Bundler-Audit Ruby 安全漏洞检查工具\",\"description\":\"Bundler-Audit 是一个用于 Ruby 项目的工具，主要用于对 Gemfile.lock 文件进行补丁级别的验证。它能够检查项目中使用的 gem 是否存在已知的安全漏洞，并提供相应的修复建议。Bundler-Audit 通过与 Ruby Advisory Database 进行对比，确保项目依赖的 gem 版本是安全的。\",\"time\":\"2025-02-26 10:28\",\"path\":\"notes/20250226_10_28\",\"category\":\"ruby\",\"tags\":[\"插件\",\"检查安全漏洞\",\"ruby\"]},{\"title\":\"mac brew 命令\",\"description\":\"brew 是 mac 的包管理工具\",\"time\":\"2025-02-28 15:10\",\"path\":\"notes/20250228_15_10\",\"category\":\"mac\",\"tags\":[\"包管理工具\",\"mac\"]},{\"title\":\"Vim 常用快捷键\",\"description\":\"\",\"time\":\"2025-03-03 17:48\",\"path\":\"notes/20250303_17_48\",\"category\":\"linux\",\"tags\":[\"vim\",\"文本工具\",\"linux\"]},{\"title\":\"Podfile、DSL 和 Ruby 语法\",\"description\":\"\",\"time\":\"2025-03-10 14:24\",\"path\":\"notes/20250310_14_24\",\"category\":\"ruby\",\"tags\":[\"ruby\"]},{\"title\":\"“向量化模型”与”矢量数据库“ 去实现图片向量搜索\",\"description\":\"\",\"time\":\"2025-03-25 09:56\",\"path\":\"notes/20250325_09_51\",\"category\":\"python\",\"tags\":[\"python\",\"向量化模型\",\"矢量数据库\",\"图片向量搜索\"]},{\"title\":\"产前物品清单\",\"description\":\"\",\"time\":\"2025-04-02 16:52\",\"path\":\"notes/20250402_16_52\",\"category\":\"产前笔记\",\"tags\":[\"产前笔记\"]},{\"title\":\"Linux服务管理命令 service 与 systemctl\",\"description\":\"description:\",\"time\":\"2025-04-02 18:35\",\"path\":\"notes/20250402_18_35\",\"category\":\"linux\",\"tags\":[\"服务管理\",\"linux\"]}],\"categorys\":{\"ruby\":[{\"title\":\"Bundler-Audit Ruby 安全漏洞检查工具\",\"description\":\"Bundler-Audit 是一个用于 Ruby 项目的工具，主要用于对 Gemfile.lock 文件进行补丁级别的验证。它能够检查项目中使用的 gem 是否存在已知的安全漏洞，并提供相应的修复建议。Bundler-Audit 通过与 Ruby Advisory Database 进行对比，确保项目依赖的 gem 版本是安全的。\",\"time\":\"2025-02-26 10:28\",\"path\":\"notes/20250226_10_28\",\"category\":\"ruby\",\"tags\":[\"插件\",\"检查安全漏洞\",\"ruby\"]},{\"title\":\"Podfile、DSL 和 Ruby 语法\",\"description\":\"\",\"time\":\"2025-03-10 14:24\",\"path\":\"notes/20250310_14_24\",\"category\":\"ruby\",\"tags\":[\"ruby\"]}],\"mac\":[{\"title\":\"mac brew 命令\",\"description\":\"brew 是 mac 的包管理工具\",\"time\":\"2025-02-28 15:10\",\"path\":\"notes/20250228_15_10\",\"category\":\"mac\",\"tags\":[\"包管理工具\",\"mac\"]}],\"linux\":[{\"title\":\"Vim 常用快捷键\",\"description\":\"\",\"time\":\"2025-03-03 17:48\",\"path\":\"notes/20250303_17_48\",\"category\":\"linux\",\"tags\":[\"vim\",\"文本工具\",\"linux\"]},{\"title\":\"Linux服务管理命令 service 与 systemctl\",\"description\":\"description:\",\"time\":\"2025-04-02 18:35\",\"path\":\"notes/20250402_18_35\",\"category\":\"linux\",\"tags\":[\"服务管理\",\"linux\"]}],\"python\":[{\"title\":\"“向量化模型”与”矢量数据库“ 去实现图片向量搜索\",\"description\":\"\",\"time\":\"2025-03-25 09:56\",\"path\":\"notes/20250325_09_51\",\"category\":\"python\",\"tags\":[\"python\",\"向量化模型\",\"矢量数据库\",\"图片向量搜索\"]}],\"产前笔记\":[{\"title\":\"产前物品清单\",\"description\":\"\",\"time\":\"2025-04-02 16:52\",\"path\":\"notes/20250402_16_52\",\"category\":\"产前笔记\",\"tags\":[\"产前笔记\"]}]},\"tags\":{\"插件\":[{\"title\":\"Bundler-Audit Ruby 安全漏洞检查工具\",\"description\":\"Bundler-Audit 是一个用于 Ruby 项目的工具，主要用于对 Gemfile.lock 文件进行补丁级别的验证。它能够检查项目中使用的 gem 是否存在已知的安全漏洞，并提供相应的修复建议。Bundler-Audit 通过与 Ruby Advisory Database 进行对比，确保项目依赖的 gem 版本是安全的。\",\"time\":\"2025-02-26 10:28\",\"path\":\"notes/20250226_10_28\",\"category\":\"ruby\",\"tags\":[\"插件\",\"检查安全漏洞\",\"ruby\"]}],\"检查安全漏洞\":[{\"title\":\"Bundler-Audit Ruby 安全漏洞检查工具\",\"description\":\"Bundler-Audit 是一个用于 Ruby 项目的工具，主要用于对 Gemfile.lock 文件进行补丁级别的验证。它能够检查项目中使用的 gem 是否存在已知的安全漏洞，并提供相应的修复建议。Bundler-Audit 通过与 Ruby Advisory Database 进行对比，确保项目依赖的 gem 版本是安全的。\",\"time\":\"2025-02-26 10:28\",\"path\":\"notes/20250226_10_28\",\"category\":\"ruby\",\"tags\":[\"插件\",\"检查安全漏洞\",\"ruby\"]}],\"ruby\":[{\"title\":\"Bundler-Audit Ruby 安全漏洞检查工具\",\"description\":\"Bundler-Audit 是一个用于 Ruby 项目的工具，主要用于对 Gemfile.lock 文件进行补丁级别的验证。它能够检查项目中使用的 gem 是否存在已知的安全漏洞，并提供相应的修复建议。Bundler-Audit 通过与 Ruby Advisory Database 进行对比，确保项目依赖的 gem 版本是安全的。\",\"time\":\"2025-02-26 10:28\",\"path\":\"notes/20250226_10_28\",\"category\":\"ruby\",\"tags\":[\"插件\",\"检查安全漏洞\",\"ruby\"]},{\"title\":\"Podfile、DSL 和 Ruby 语法\",\"description\":\"\",\"time\":\"2025-03-10 14:24\",\"path\":\"notes/20250310_14_24\",\"category\":\"ruby\",\"tags\":[\"ruby\"]}],\"包管理工具\":[{\"title\":\"mac brew 命令\",\"description\":\"brew 是 mac 的包管理工具\",\"time\":\"2025-02-28 15:10\",\"path\":\"notes/20250228_15_10\",\"category\":\"mac\",\"tags\":[\"包管理工具\",\"mac\"]}],\"mac\":[{\"title\":\"mac brew 命令\",\"description\":\"brew 是 mac 的包管理工具\",\"time\":\"2025-02-28 15:10\",\"path\":\"notes/20250228_15_10\",\"category\":\"mac\",\"tags\":[\"包管理工具\",\"mac\"]}],\"vim\":[{\"title\":\"Vim 常用快捷键\",\"description\":\"\",\"time\":\"2025-03-03 17:48\",\"path\":\"notes/20250303_17_48\",\"category\":\"linux\",\"tags\":[\"vim\",\"文本工具\",\"linux\"]}],\"文本工具\":[{\"title\":\"Vim 常用快捷键\",\"description\":\"\",\"time\":\"2025-03-03 17:48\",\"path\":\"notes/20250303_17_48\",\"category\":\"linux\",\"tags\":[\"vim\",\"文本工具\",\"linux\"]}],\"linux\":[{\"title\":\"Vim 常用快捷键\",\"description\":\"\",\"time\":\"2025-03-03 17:48\",\"path\":\"notes/20250303_17_48\",\"category\":\"linux\",\"tags\":[\"vim\",\"文本工具\",\"linux\"]},{\"title\":\"Linux服务管理命令 service 与 systemctl\",\"description\":\"description:\",\"time\":\"2025-04-02 18:35\",\"path\":\"notes/20250402_18_35\",\"category\":\"linux\",\"tags\":[\"服务管理\",\"linux\"]}],\"python\":[{\"title\":\"“向量化模型”与”矢量数据库“ 去实现图片向量搜索\",\"description\":\"\",\"time\":\"2025-03-25 09:56\",\"path\":\"notes/20250325_09_51\",\"category\":\"python\",\"tags\":[\"python\",\"向量化模型\",\"矢量数据库\",\"图片向量搜索\"]}],\"向量化模型\":[{\"title\":\"“向量化模型”与”矢量数据库“ 去实现图片向量搜索\",\"description\":\"\",\"time\":\"2025-03-25 09:56\",\"path\":\"notes/20250325_09_51\",\"category\":\"python\",\"tags\":[\"python\",\"向量化模型\",\"矢量数据库\",\"图片向量搜索\"]}],\"矢量数据库\":[{\"title\":\"“向量化模型”与”矢量数据库“ 去实现图片向量搜索\",\"description\":\"\",\"time\":\"2025-03-25 09:56\",\"path\":\"notes/20250325_09_51\",\"category\":\"python\",\"tags\":[\"python\",\"向量化模型\",\"矢量数据库\",\"图片向量搜索\"]}],\"图片向量搜索\":[{\"title\":\"“向量化模型”与”矢量数据库“ 去实现图片向量搜索\",\"description\":\"\",\"time\":\"2025-03-25 09:56\",\"path\":\"notes/20250325_09_51\",\"category\":\"python\",\"tags\":[\"python\",\"向量化模型\",\"矢量数据库\",\"图片向量搜索\"]}],\"产前笔记\":[{\"title\":\"产前物品清单\",\"description\":\"\",\"time\":\"2025-04-02 16:52\",\"path\":\"notes/20250402_16_52\",\"category\":\"产前笔记\",\"tags\":[\"产前笔记\"]}],\"服务管理\":[{\"title\":\"Linux服务管理命令 service 与 systemctl\",\"description\":\"description:\",\"time\":\"2025-04-02 18:35\",\"path\":\"notes/20250402_18_35\",\"category\":\"linux\",\"tags\":[\"服务管理\",\"linux\"]}]}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>