<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VitePress</title>
    <meta name="description" content="bolg ...">
    <meta name="generator" content="VitePress v1.0.0-rc.44">
    <link rel="preload stylesheet" href="/assets/style.CR8b1gJb.css" as="style">
    
    <script type="module" src="/assets/app.Dm3e60ip.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Bu8hRsVA.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.Cohn-APp.js">
    <link rel="modulepreload" href="/assets/chunks/theme.CC2FKeBM.js">
    <link rel="modulepreload" href="/assets/document_services_ruby_rails_Rails Model 数据模型层.md.CIjdELca.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div><div class="w-screen h-[0px]"><div class="w-[300px] h-[400px] fixed top-[110px] left-[-299.9px] hover:left-0 z-[999] hover:bg-[#fff] hover:shadow-xl hover:border-[1px] hover:border-solid hover:border-[#EFF0F3] rounded-l-[8px] overflow-x-hidden overflow-y-scroll"><div class="mt-[10px] mx-[10px]"><span class="mb-[10px] block text-[13px] text-[#94938E] px-[5px]">Content Menu</span><!--[--><div class="mb-[2px] hover:bg-[#F6F6F7] px-[8px] py-[6px] rounded-[4px]"><div class="flex items-center"><div class="w-[20px] h-[20px] mr-[8px] flex justify-center items-center"><img src="/icons/develops.png" alt="" class="w-[20px] h-[auto]"></div><a href="/document/develop/" class="no-underline text-[#333] text-[14.5px] hover:text-[#069A8B] hover:underline">独立开发资料</a></div><!----></div><div class="mb-[2px] hover:bg-[#F6F6F7] px-[8px] py-[6px] rounded-[4px]"><div class="flex items-center"><div class="w-[20px] h-[20px] mr-[8px] flex justify-center items-center"><img src="/icons/views.png" alt="" class="w-[20px] h-[auto]"></div><a href="/document/views/" class="no-underline text-[#333] text-[14.5px] hover:text-[#069A8B] hover:underline">前端开发资料</a></div><!----></div><div class="mb-[2px] hover:bg-[#F6F6F7] px-[8px] py-[6px] rounded-[4px]"><div class="flex items-center"><div class="w-[20px] h-[20px] mr-[8px] flex justify-center items-center"><img src="/icons/services.png" alt="" class="w-[20px] h-[auto]"></div><a href="/document/services/" class="no-underline text-[#333] text-[14.5px] hover:text-[#069A8B] hover:underline">服务端开发资料</a></div><!----></div><div class="mb-[2px] hover:bg-[#F6F6F7] px-[8px] py-[6px] rounded-[4px]"><div class="flex items-center"><div class="w-[20px] h-[20px] mr-[8px] flex justify-center items-center"><img src="/icons/works.png" alt="" class="w-[20px] h-[auto]"></div><a href="/document/workers/" class="no-underline text-[#333] text-[14.5px] hover:text-[#069A8B] hover:underline">工作笔记</a></div><!----></div><!--]--></div></div></div><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar" data-v-7ad780c2 data-v-3efcd581><div class="wrapper" data-v-3efcd581><div class="container" data-v-3efcd581><div class="title" data-v-3efcd581><div class="VPNavBarTitle" data-v-3efcd581 data-v-0ad69264><a class="title" href="/" data-v-0ad69264><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.png" alt data-v-ab19afbb><!--]--><!----><!--[--><!--]--></a></div></div><div class="content" data-v-3efcd581><div class="content-body" data-v-3efcd581><!--[--><!--]--><div class="VPNavBarSearch search" data-v-3efcd581><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-3efcd581 data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>首页</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="mailto:zouzhuqorg@gmail.com" target="_blank" rel="noreferrer" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>联系我</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-3efcd581 data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-283b26e9 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-3efcd581 data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/zouzhu-code-89" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><a class="VPSocialLink no-icon" href="..." aria-label="twitter" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-twitter" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-3efcd581 data-v-8e87c032 data-v-af5898d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-af5898d3><span class="vpi-more-horizontal icon" data-v-af5898d3></span></button><div class="menu" data-v-af5898d3><div class="VPMenu" data-v-af5898d3 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-8e87c032><div class="item appearance" data-v-8e87c032><p class="label" data-v-8e87c032>Appearance</p><div class="appearance-action" data-v-8e87c032><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-8e87c032 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div></div></div><div class="group" data-v-8e87c032><div class="item social-links" data-v-8e87c032><div class="VPSocialLinks social-links-list" data-v-8e87c032 data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/zouzhu-code-89" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><a class="VPSocialLink no-icon" href="..." aria-label="twitter" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-twitter" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-3efcd581 data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-3efcd581><div class="divider-line" data-v-3efcd581></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-0b5c97a1><button data-v-0b5c97a1>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-6b52fe58><div class="content" data-v-6b52fe58><div class="outline-marker" data-v-6b52fe58></div><div class="outline-title" role="heading" aria-level="2" data-v-6b52fe58>目录大纲</div><nav aria-labelledby="doc-outline-aria-label" data-v-6b52fe58><span class="visually-hidden" id="doc-outline-aria-label" data-v-6b52fe58> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-6b52fe58 data-v-53c99d69><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _document_services_ruby_rails_Rails%20Model%20%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%B1%82" data-v-e6f2a212><div><p>Model 也就是我们通常说的一些模块，在编程语言里面通常理解成 ORM 概念 Object Relational Model ，实际上就是从编程角度的一个对象结构和数据库的一张表或一个数据模型做一个映射的关系(数据映射 Mapping)。</p><h2 id="model-原理简介与项目配置" tabindex="-1">Model 原理简介与项目配置 <a class="header-anchor" href="#model-原理简介与项目配置" aria-label="Permalink to &quot;Model 原理简介与项目配置&quot;">​</a></h2><p>Ruby 是一个非常强大的面向对象语言，在 Rails 实际上是提供了一个 ActiveRecord 这样一个 gem，它是目前比较强大且应用的一个 ORM 关系库。</p><p>Rails 对数据库的支持情况，默认数据库是 SQLite，同样支持 MySQL，PostgreSQL，Oracle，SQLServer，MongoDB: NoSQL，etc.... 对于 NoSQL 传统关系型数据的支持，例如 mongodb，我们需要下载 Mongoid，MongoMapper 这两个 gem，它们就是完成了 ORM 的一个映射，Ruby 对象 → 数据层面的一个对应关系。</p><p>Rails 数据库配置文件在 config/database.yml 里面，Rails 默认帮我们生成了 development(开发环境)，test(测试环境)，production(生产环境) 三个环境供工程使用.</p><p>因为我们不使用 sqlite 这个文本型数据库，大多使用 mysql 数据库，所以我们要将 Gemfile 文件里面的 gem &#39;sqlite3&#39; 改为 gem &#39;mysql2&#39; ，然后运行 bundle 安装下这个 mysql2 这个 gem 就好了。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># default: &amp;default 相当于一个键值对的配置，相当于面向对象继承这样一个概念</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 这部分结构是固定的，下面的 3 个 development,test,production 相当与都是</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 继承 default 的,不同环境下面是通用的配置。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 应用场景，我们可以将通用的配置都放到 default 里面，然后不同环境不同的配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 项，就单独放在各自的环境中。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 默认的配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># default: &amp;default</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   adapter: sqlite3</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   pool: &lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 } %&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   timeout: 5000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 开发环境</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># default: &amp;default</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   adapter: sqlite3</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   pool: &lt;%= ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 } %&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   timeout: 5000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 开发环境</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># development:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   # 引用了 default 默认通用配置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   &lt;&lt;: *default</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   database: db/development.sqlite3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 测试环境</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># test:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   &lt;&lt;: *default</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   database: db/test.sqlite3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 生产环境</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># production:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   &lt;&lt;: *default</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   database: db/production.sqlite3</span></span></code></pre></div><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 上面都是 Rails 项目创建的默认配置，需要对应项目需求做相应的修改</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  adapter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mysql2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # 数据库类型</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  encoding</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">utf8</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 数据库编码方式</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  pool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             # 数据库连接池默认是5个连接  </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">127.0.0.1</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # 数据库IP地址 </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">root</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 数据库用户名</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 数据库密码，默认为空</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 针对不同的应用环境，我们也是采用不同的数据库 database 做了一个单独的配置,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在数据命名上面，我们最好也能参照 name_development name_test，方便我们</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 识别数据库的作用， </span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">development</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  database</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">circles_development</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  database</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">circles_test</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">production</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  database</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">circles_production</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">circles</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">circles_p_production</span></span></code></pre></div><p>配置完成后需要启动本地的数据库，启动后就可以执行 rake db:create 命令，也就是为项目创建当前的这个数据库， 创建数据库需要 username 为 root，因为 mysql 里面默认 root 账号才有创建数据库的权限 。</p><p><img src="/services/rails/Untitled.png" alt="Untitled"></p><p>我们可以使用 rake -T 命令来查看当前项目里面所有的 rake 命令 ，我们就可以查看到 rake db:create 这条 rake 命令了 , 目前为止就完成了 Rails 项目对 mysql 数据库支持的操作配置。</p><p><img src="/services/rails/Untitled 1.png" alt="Untitled"></p><h3 id="建立-user-model-第一个模型" tabindex="-1">建立 User Model (第一个模型) <a class="header-anchor" href="#建立-user-model-第一个模型" aria-label="Permalink to &quot;建立 User Model (第一个模型)&quot;">​</a></h3><p>1.针对 User Model 的建立，实际上就是从数据库层面建立用户这张表，可以通过 rails 命令创建 user model</p><p>~ rails g model user</p><p>可以看到 rails 帮工程生成了一些列与数据库相关联的文件，都有各自的作用</p><ul><li>20211129142348_create_users.rb 主要用来定义表字段，表索引，跟表结构用的</li><li>app/models/user.rb 主要是 model 层面映射的 orm 模型文件</li></ul><p><img src="/services/rails/Untitled 2.png" alt="Untitled"></p><p>2.先在 20211129142348_create_users.rb 中定义表的结构，用户表基本结构(用户名，密码)</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rails 帮我们定义好了类和def change方法，我们不需要更改，仅仅只需要定义字段就好了</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CreateUsers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ActiveRecord::Migration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> change</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 创建一张表，这张表就是 users，下面定义的变量可以创建表结构</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    create_table </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |t|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      t.string </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:username</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  # 用户名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      t.string </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:password</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  # 密码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      t.timestamps </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      # 时间戳：默认的(创建时间，更新时间如下)不需要可以删除</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>3.运行 rake 移植命令，它就会帮我们执行 db/migrate 下面所有未执行的数据库移植文件，原理 ：rails 默认底层会创建一张数据库表，来维护记录当前版本执行到了哪个文件，这就是为什么在移植文件前面，rails 在文件名称前面添加了一段时间戳，这就是方便团队协作开发的时候，出现前后不一致的情况 。结果：这样我们就得到了一张 users table 用户表！</p><p>~ rake db:migrate</p><p><img src="/services/rails/Untitled 3.png" alt="Untitled"></p><p>4.models/user.rb 也是 rails 帮我们定义好的一个类，它是继承于 ActiveRecord::Base 基类的，实际上这样一个简单的继承就帮我们完成了当前这个类，到数据库内部 users 这张表之间所有的映射关系，所以我们当前可以直接针对 users 这个类，执行所有增删改查的操作，那怎么去测试呢 ？我们可以直接使用 ~ rails c 这个命令直接进入到 rails 的终端环境去调用类或方法，整个工程的变量，类，方法都是共享的，所以我们可以操作 User 这个类去做增删改查 .</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># User.create                       创建数据</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># User.all.to_a                  查询所有数据，并转为array</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># User.first                        查询第一条数据</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># user.username = &quot;zhu,zou&quot;   修改数据直接修改，在调用 save 方法即可</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># user.destroy                删除这条数据</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可以看到下面的输出，Rails 也帮我们打印了原生 sql 的语句</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><img src="/services/rails/Untitled 4.png" alt="Untitled"></p><h2 id="curd-读写数据方法" tabindex="-1">CURD 读写数据方法 <a class="header-anchor" href="#curd-读写数据方法" aria-label="Permalink to &quot;CURD 读写数据方法&quot;">​</a></h2><p>CRUD 是我们用来对数据进行操作的四个动词的缩写：Create， Reader，Update 和 Delete，Active Record 自动创建允许应用程序读取和操作存储在其表中的数据的方法</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 继承 ActiveRecord::Base 完成了对象层跟数据层ORM映射，所以我们可以直接根据 User 操作数据库</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="create-创建数据" tabindex="-1"><strong>create 创建数据</strong> <a class="header-anchor" href="#create-创建数据" aria-label="Permalink to &quot;**create 创建数据**&quot;">​</a></h3><p>active Record 对象可以从散列、块创建，或者在创建后手动设置它们的属性，该 new 方法返回一个新对象，同时 create将返回该对象并将其保存到数据库中.</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 提供了3种创建表的方式，调用方法后生成了3条数据</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># id|username    |password   |created_at         |updated_at         |</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># --+------------+-----------+-------------------+-------------------+</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 20|zhu,zou     |123456     |2021-11-30 03:10:33|2021-11-30 03:10:33|</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 21|new zhu,zou |new 123456 |2021-11-30 03:10:33|2021-11-30 03:10:33|</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 22|code zhu,zou|code 123456|2021-11-30 03:10:33|2021-11-30 03:10:33|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UsersController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationController</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 用户详情页面</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> descript</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_anthor(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zhu,zou&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;123456&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 创建一个账户</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create_anthor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(username, password)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 1.方式就是直接使用模型类的静态方法 create 创建</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> username, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">password:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> password)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 2.通过实例化模型类对象，然后通过属性赋值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user1.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;new </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{username}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user1.password </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;new </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{password}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user1.save</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 3.如果提供了一个块，则create和new都会为该块生成新对象以进行初始化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |u|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            u.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;code </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{username}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            u.password </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;code </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{password}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user2.save</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="all-first-find-by-where-查询数据" tabindex="-1"><strong>all / first / find_by / where 查询数据</strong> <a class="header-anchor" href="#all-first-find-by-where-查询数据" aria-label="Permalink to &quot;**all / first / find_by / where 查询数据**&quot;">​</a></h3><p>Active Record 提供了丰富的 API 来访问数据库中的数据，Active Record 提供的不同数据访问方法的几个实例 ：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UsersController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationControll</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 获取数据信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> inner_all_data</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 1.查询全部数据，返回一个 users[#&lt;User:0x00007fb5ef38fe08&gt;] 对象列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.all</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        users.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |u|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;username: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{u.username}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 2.查询第一条数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user_first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.first</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 3.返回第一个username为new zhu,zou的数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user_david </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;new zhu,zou&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 4.返回所有 username: &#39;zhu,zou&#39;, password: &#39;123456&#39; 的结果集，并按照时间倒叙排列</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        users_result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;zhu,zou&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">password:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;123456&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                                             .order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">created_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :desc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 以下都可</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;username = ? and password = ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zou,zhu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;123456&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;zou,zhu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">password:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;123456&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="update-update-all-更新数据" tabindex="-1"><strong>update / update_all 更新数据</strong> <a class="header-anchor" href="#update-update-all-更新数据" aria-label="Permalink to &quot;**update / update_all 更新数据**&quot;">​</a></h3><p>一旦检索到 Active Record 对象，就可以修改其属性并将其保存到数据库中..</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UsersController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationController</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 修改用户数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> update_user_data</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 1.条件查询到改user对象，然后直接修改属性，然后调用save方法即可</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;shuangting,huang&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;zou,zhu&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user.save</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 2.使用update方法更新数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user.update </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;xiao,ming&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">password:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;password123...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 3.这在一次更新多个属性时最有用，另一方面如果您想批量更新多条记录，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        #   您可能会发现 update_all 类方法很有用，执行你会发现全部都更新了</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.update_all </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;username = &#39;Fei, Niu&#39;, password = &#39;fn123&#39;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="destory-destory-by-destory-all-删除数据" tabindex="-1"><strong>destory / destory_by / destory_all 删除数据</strong> <a class="header-anchor" href="#destory-destory-by-destory-all-删除数据" aria-label="Permalink to &quot;**destory / destory_by / destory_all 删除数据**&quot;">​</a></h3><p>同样一旦检索到 Active Record 对象，就可以销毁它，从而将其从数据库中删除</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UsersController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationController</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 删除数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> delete_user_data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 1.查询单挑数据进行删除</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;zou,zhu&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        user.destroy</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 2.删除所有指定条件的数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.destroy_by(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;zou,zhu&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 3.删除全部数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.destroy_all</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="find-or-initialize-by-查找" tabindex="-1">find_or_initialize_by 查找 <a class="header-anchor" href="#find-or-initialize-by-查找" aria-label="Permalink to &quot;find_or_initialize_by 查找&quot;">​</a></h3><p>查找记录，与 find 不同的是，find_or_initialize_by 在找不到对象时可以 new 一个新对象，常常用于更新操作</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查找到记录则更新旧数据，没有则创建一个</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_or_initialize_by </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">email:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;zouzhuqorg@gmail.com&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user.age </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 24</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user.save!</span></span></code></pre></div><h2 id="查询操作常用方法" tabindex="-1">查询操作常用方法 <a class="header-anchor" href="#查询操作常用方法" aria-label="Permalink to &quot;查询操作常用方法&quot;">​</a></h2><p>这里将列举 Model 查询操作的一些常用方法，例如条件约束，以及排序、分页等等.....</p><h3 id="select-field-返回指定字段结果集" tabindex="-1">select(:field) 返回指定字段结果集 <a class="header-anchor" href="#select-field-返回指定字段结果集" aria-label="Permalink to &quot;select(:field) 返回指定字段结果集&quot;">​</a></h3><p>如果我们想指定返回的结果集有哪些指定的字段，我们可以使用 select 方法</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 我们指定了username,age,这样就只会返回它们，id 总是会返回输出</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:age</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; [#&lt;User id: nil, username: &quot;value&quot;, age: &quot;value&quot;&gt;]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 同时我们也可以设置字段别名，这样我们可以根据 u_name 获取到 username 的值了, 如果访问一个没有定义的别名则会报错</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_first </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;username AS u_name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;age AS u_age&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_first.u_name</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 并且它也可以返回一个块，这样的方式得到我们想要输出的结果集，但是明显比上面來的麻烦</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Model</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.all.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { |m| m.field </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;username&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><h3 id="not-非条件" tabindex="-1">not 非条件 <a class="header-anchor" href="#not-非条件" aria-label="Permalink to &quot;not 非条件&quot;">​</a></h3><p>not 非条件常常伴随着 where 条件，并且 where 可以不附带任何条件约束</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where.not(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">orders_count:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># SELECT * FROM customers WHERE (customers.orders_count NOT IN (1,3,5))</span></span></code></pre></div><h3 id="or-或条件" tabindex="-1">or 或条件 <a class="header-anchor" href="#or-或条件" aria-label="Permalink to &quot;or 或条件&quot;">​</a></h3><p>通过 or 我们可以将两个查询条件连接起来</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">last_name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Smith&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).or(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">orders_count:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># SELECT * FROM customers WHERE (customers.last_name = &#39;Smith&#39; OR customers.orders_count IN (1,3,5))</span></span></code></pre></div><h3 id="order-排序" tabindex="-1">order 排序 <a class="header-anchor" href="#order-排序" aria-label="Permalink to &quot;order 排序&quot;">​</a></h3><p>查询到的数据可以根据 order 进行升序、倒序、排序处理....</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 按照 id 排序，默人升序</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 按照某字段升序(asc) 或者降序(desc)排序</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :desc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">或者</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.order(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id desc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#多个字段排序</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :desc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :asc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">or</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :desc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">or</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.order(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id asc, name desc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">or</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.order(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id asc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;name desc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用多个 order 都将会合并到第一个</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.order(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :desc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).oder(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :asc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="page-pre-limit-分页" tabindex="-1">page / pre / limit 分页 <a class="header-anchor" href="#page-pre-limit-分页" aria-label="Permalink to &quot;page / pre / limit 分页&quot;">​</a></h3><p>page 代表页码，而 pre 则代表每页的条目数</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 这里的意思就是默人第一页，每页最多 20 条数据进行分页</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.all(params[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:page</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pre(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># limit 则是只查询返回两条数据</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.all.limit(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="find-each-返回循环块" tabindex="-1">find_each 返回循环块 <a class="header-anchor" href="#find-each-返回循环块" aria-label="Permalink to &quot;find_each 返回循环块&quot;">​</a></h3><p>find_each 可以返回一个块，循环输出子元素，就像使用 forEach 一样</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.all.find_each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |user|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;zouzhu&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;your are Zouzhu&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;your are&#39;not Zouzhu&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="pluck-查询单列或多列" tabindex="-1"><strong>pluck 查询单列或多列</strong> <a class="header-anchor" href="#pluck-查询单列或多列" aria-label="Permalink to &quot;**pluck 查询单列或多列**&quot;">​</a></h3><p>pluck 可用于从模型的基础表中查询单列或多列，它接受列名作为参数，并返回具有相应数据类型值的数组，与 select 不同，pluck 直接将数据库结果转换为 Ruby Array ，无需构造 ActiveRecord 对象，对于大型或频繁运行的查询，这可能意味着更好的性能，但是任何模型方法都将不可用比如 where、order 等等，因为它此时不是个 ActiveRecord Model 对象，所以最好放在链式查询的最后面。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># select users.id, users.username from users</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; [[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ZouZhu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;PiXiaoYang&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;HuangShuangTing&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不仅可以从单个表中查询字段，还可以查询多个表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Order</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.joins(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:books</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).pluck(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;orders.created_at, customers.email, books.title&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="find-by-sql-通过-sql-查找" tabindex="-1"><strong>find_by_sql 通过 sql 查找</strong> <a class="header-anchor" href="#find-by-sql-通过-sql-查找" aria-label="Permalink to &quot;**find_by_sql 通过 sql 查找**&quot;">​</a></h3><p>如果你想使用自己的 SQL 查找表中的记录，可以使用 find_by_sql，即使基础查询只返回一条记录，find_by_sql 方法也将返回一个对象数组。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by_sql(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SELECT * FROM customers INNER JOIN orders ON customers.id = orders.customer_id ORDER BY customers.created_at desc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  =&gt; [</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#&lt;Customer id: 1, first_name: &quot;Lucas&quot; ...&gt;, #&lt;Customer id: 2, first_name: &quot;Jan&quot; ...&gt;, ...]</span></span></code></pre></div><h3 id="connection-select-all-通过-sql-查找" tabindex="-1">connection.<strong>select_all 通过 sql 查找</strong> <a class="header-anchor" href="#connection-select-all-通过-sql-查找" aria-label="Permalink to &quot;connection.**select_all 通过 sql 查找**&quot;">​</a></h3><p>connection.select_all 的功能跟 find_by_sql 相似 ，select_all 将使用自定义 SQL 从数据库检索对象，但不会实例化它们，此方法将返回 ActiveRecord::Result 类的一个实例，对该对象调用 to_a 将返回一个哈希数组，其中每个哈希表示一条记录。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.connection.select_all(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SELECT first_name, created_at FROM customers WHERE id = &#39;1&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).to_a</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  =&gt; [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;first_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Rafael&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2012-11-10 23:23:45.281189&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;first_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Eileen&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;created_at&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2013-12-09 11:22:35.221282&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">         ]</span></span></code></pre></div><h3 id="ids-返回主键列表" tabindex="-1"><strong>ids 返回主键列表</strong> <a class="header-anchor" href="#ids-返回主键列表" aria-label="Permalink to &quot;**ids 返回主键列表**&quot;">​</a></h3><p>ids 可返回 table 中主键列表</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ids   </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # SELECT id FROM customers</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Customer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # model 对象声明了 primary_key 则返回这个字段列表</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.primary_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;customer_id&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ids    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># SELECT customer_id FROM customers</span></span></code></pre></div><h3 id="exists-对象是否存在" tabindex="-1"><strong>exists? 对象是否存在</strong> <a class="header-anchor" href="#exists-对象是否存在" aria-label="Permalink to &quot;**exists? 对象是否存在**&quot;">​</a></h3><p>如果你只是想检查对象是否存在，则可以使用 exists? 方法 ，但它不会返回对象或对象集合，而是返回 true 或 false</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.exists?(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)                                        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可以检索一个 id</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.exists?(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])                              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 也可以是特定字段的一个范围, 只要有1个在表列中存在，否将返回 true，否则返回 false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.exists?(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">first_name:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Jane&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Sergei&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])      </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">first_name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Ryan&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).exists?                 </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 也可以不携带条件，跟 where 一起使用.</span></span></code></pre></div><h3 id="动态方法查找" tabindex="-1">动态方法查找 <a class="header-anchor" href="#动态方法查找" aria-label="Permalink to &quot;动态方法查找&quot;">​</a></h3><p>对于表中定义的每个字段（也称为属性），Active Record 都提供一个查找器方法，例如你的模型中（表中）有个 first_name 字段，Rails Model 将帮我们创建一个 find_by_first_name 方法。如果你的 model 模型中有一个 locked 方法，也将帮我们创建一个 find_by_locked 方法。</p><p>你还可以在方法后面指定感叹号（！）这样则如果它们不返回任何记录数据，则会引发 ActiveRecord:：RecordNotFound 错误。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by_first_name!(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zouzhu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>如果你想检索多个条件，你的方法可以使用 and 进行拼接，例如现在我们想检索 first_name 和 orders_count (名字和订单数量) 这两个字段。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by_first_name_and_orders_count(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zouzhu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="includes-防止-n-1-查找" tabindex="-1"><strong>includes() 防止 n+ 1 查找</strong> <a class="header-anchor" href="#includes-防止-n-1-查找" aria-label="Permalink to &quot;**includes() 防止 n+ 1 查找**&quot;">​</a></h3><p>n + 1 查询通常发生在关联的查询中，例如下面的例子，如果不懂关联查询，请先看 model 关联关系章节在来看这个章节 。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># 返回 blogs 列表，如下图所示，这里执行了一条 sql </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@blogs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Blog.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">page</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># 按下图 UI 进行还原</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ul</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @blogs.each do </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">blog</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">li</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&lt;%=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">blog.id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%&gt;&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&lt;%=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">blog.title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%&gt;&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            # 这里循环迭代了 tag ，会生成很多条 sql 语句, 挨个去查找于 blog 有关联关系的 tag，而且是逐个查找，这样有 n 个 tag 就生成了 n 个 sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                &lt;%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> blog.tags.each do </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tag</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&lt;%=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tag.name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                &lt;%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            # 这里查询 anthor 作者的名称也是每个 bolg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id 都会对应循环查找 user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id, 这里有 n 条 blog, 就会生成 n 条查找 user 记录的 sql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&lt;%=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">blog.user.anthor</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%&gt;&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">span</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        &lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">li</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    &lt;%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> end </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ul</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p><img src="/services/rails/1111.png" alt="1111.png"></p><p>这里为了达到左边一个简单的效果，在 controller 层是执行了 1 个 sql，而返回 blog 关联的 tag 就执行 n 条操作，这里就是 n+1 操作 ，这里有两个关联还查询了 user 表的作者，这里又执行了 n 条操作，所以加起来有 2n + 1 条 sql .</p><p>那我们怎么去规避这种现象呢 ？Rails 给我们提供了一个 includes() 方法，我们在查询 blogs 的时候，顺便同时把于 blogs 关联的 tags，user 都查询了不久可以了。</p><p><strong>@blogs = Blog.page(10).includes(:tags, :user)；</strong></p><p>这样会生成一个 in 的操作，比如返回的 10 条 bolgs，都有标签 1，2，3，4，5 关联的 tag_id，Rails 会帮我们我们生成</p><p>selct tags* from tags where id in (1,2,3,4,5)，下面代码解释更加详细 。</p><p>总而言之 includes 的出现就是避免了 n + 1 的情况，大大减轻了给数据库的执行压力，所以当我们 each 获取关联的数据的时候，我们尽量使用 includes ，这也是性能优化了吧 ！</p><p>当然如果我们还想 each 获取 user 后面的关联，我们可以使用数组的方式 ：<strong>@blogs = Blog.page(10).includes(:tags, [:user，:table_name....])；</strong></p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> blogs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> blogs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                           # 这样就查询到了 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 条 blog 记录，就能得到这10篇博客中的 tag_id (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...), user关联的有 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tags</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)            # blogs 这 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 篇博客所有的 tags</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">where</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)                  # blogs 这 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 篇博客所有的 users</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># 查询到的数据都会被 rails cache 缓存机制缓存，当在 view 层调用 each 获取关联的 tags， users 的时候，就不会真正的在数据库执行 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">，而是使用的是缓存的数据，这样在项目数据量逐渐庞大的时候，</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># 不会因为大量的 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 语句，给数据库特别大的压力，这就是 includes 的好处.</span></span></code></pre></div><h2 id="model-数量计算常用方法" tabindex="-1">Model 数量计算常用方法 <a class="header-anchor" href="#model-数量计算常用方法" aria-label="Permalink to &quot;Model 数量计算常用方法&quot;">​</a></h2><p>本章将罗列一些对数据数量操作的一些常用方法...</p><h3 id="count-总条数" tabindex="-1">Count 总条数 <a class="header-anchor" href="#count-总条数" aria-label="Permalink to &quot;Count 总条数&quot;">​</a></h3><p>count 可以返回查询到的数据总条数</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 计算总条数</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.all.count()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 也可以携带条件</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.all.count(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:title</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="sum-统计总和" tabindex="-1">Sum 统计总和 <a class="header-anchor" href="#sum-统计总和" aria-label="Permalink to &quot;Sum 统计总和&quot;">​</a></h3><p>sum 返回计算表中某个数字类型字段的总和</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 计算平均年龄</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.sum(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;age&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.count</span></span></code></pre></div><h2 id="model-更新操作常用方法" tabindex="-1"><strong>Model 更新操作常用方法</strong> <a class="header-anchor" href="#model-更新操作常用方法" aria-label="Permalink to &quot;**Model 更新操作常用方法**&quot;">​</a></h2><p>本章将介绍 model 对象常用的一些更新数据的方法，比如 update_attributes ，update_attribute，attributes，changed? ，changed_attributes，等等操作方法 .</p><h3 id="update-attribute-update-attributes-attributes-更新字段数据" tabindex="-1"><strong>update_attribute / update_attributes / attributes 更新字段数据</strong> <a class="header-anchor" href="#update-attribute-update-attributes-attributes-更新字段数据" aria-label="Permalink to &quot;**update_attribute / update_attributes / attributes 更新字段数据**&quot;">​</a></h3><p>当我们更新 1 个字段的时候，通常 rails 都会让数据库把当前这条记录全部字段都更新，不管它改没改变 。如果你并不想这样，而只是想更新部分字段，你就可以使用 update_attribute 这些方法，使用这些方法的时候，是不用我们去调用 save 保存方法的，默认就是保存 。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b = Blog.first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.update_attribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:title,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Java 编程基础&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)                                    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># update_attribute 只能写一个字段，如果想更新多个字段可以使用 update_attributes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.update_attributes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">title:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;python 小白速成&quot;, money: &quot;12.50&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="changed-changed-attributes-查看对象当前是否被更改" tabindex="-1"><strong>changed? / changed_attributes 查看对象当前是否被更改</strong> <a class="header-anchor" href="#changed-changed-attributes-查看对象当前是否被更改" aria-label="Permalink to &quot;**changed? / changed_attributes 查看对象当前是否被更改**&quot;">​</a></h3><p>如果我们想查看当前记录模型是否被更改，我们可以使用 changed? 这个方法，如果我们想查看当前具体修改了哪些字段，我们就可以使用 changed_attributes 这个字段 。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b = Blog.first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.update_attribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">:title,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Java 编程基础&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.changed?                 # 为什么我们这里更新了数据，changed? 却返回 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 呢 ？这是因为没有保存的修改，才算修改，save 后的修改算是更新了, update_attribute 默认执行 save</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b = Blog.first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.title = &quot;python 小白速成&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.changed?                 # 这里我们更新 title 但是没有 save 生成 update sql 的操作，所以 changed 监听的是模型对象的改变，而非数据库记录的改变</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.changed_attributes       # 可以使用 changed_attributes 打印出，修改了哪些字段，value 是帮我们显示了旧的 value 值，但是实际上我们将 title 更改为了 “python 小白速成”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{:title </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Java 编程基础&quot;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.title</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;python 小白速成&quot;</span></span></code></pre></div><h3 id="save-create-update-attributes" tabindex="-1">save! / create! / update_attributes! <a class="header-anchor" href="#save-create-update-attributes" aria-label="Permalink to &quot;save! / create! / update_attributes!&quot;">​</a></h3><p>我们知道 save 方法如果没有保存成功会返回一个 false ，但有时候会有这种需求，就是当我们执行保存，更新操作的时候，如果没有保存成功，我们是希望 Rails 能帮我们抛出错误的，方便我们捕捉 ......... 我们就可以使用方法加感叹号这样一个形式 “save!” ，这样当没有保存成功就会给我们抛出一个 ActiveRecord::Error 的异常了 ...</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b = User new username: &quot;username&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     # 这里使用模型验证，用户名、密码都不能为空，如果不知道模型验证，请前往验证章节</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.save                                                # 这里使用 save 没有保存成功只会返回 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                      </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b.save!                                               # 这里使用 save! 没有保存成功则会抛出异常.... </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ActiveRecord::Error ..................</span></span></code></pre></div><h2 id="activerecord-error-常见异常类型" tabindex="-1"><strong>ActiveRecord::Error 常见异常类型</strong> <a class="header-anchor" href="#activerecord-error-常见异常类型" aria-label="Permalink to &quot;**ActiveRecord::Error 常见异常类型**&quot;">​</a></h2><p>有时候我们会针对 model orm 层对数据库映射操作，一些失败的操作使它主动抛出 ActiveRecord::Error 类型异常，然后我们可以监听异常，当异常发生时做一些业务处理.....</p><h3 id="activerecord-recordnotfound-查找没有发现数据异常" tabindex="-1"><strong>ActiveRecord::RecordNotFound 查找没有发现数据异常</strong> <a class="header-anchor" href="#activerecord-recordnotfound-查找没有发现数据异常" aria-label="Permalink to &quot;**ActiveRecord::RecordNotFound 查找没有发现数据异常**&quot;">​</a></h3><p>当我们调用 find 如果没有查询到数据会返回 false，同理如果你想在没有查找到数据的时候抛出异常你可以使用 find！ ，当没有查找到数据的时候就会报 ActiveRecord::RecordNotFound 错误</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> User.find</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 1001</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                                             # users 中查询 id = 1001 的记录，如果没有这条记录则抛出错误</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  ActiveRecord::RecordNotFound</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ..................</span></span></code></pre></div><h3 id="activerecord-unknownattributeerror-没有声明字段异常" tabindex="-1"><strong>ActiveRecord::UnknownAttributeError 没有声明字段异常</strong> <a class="header-anchor" href="#activerecord-unknownattributeerror-没有声明字段异常" aria-label="Permalink to &quot;**ActiveRecord::UnknownAttributeError 没有声明字段异常**&quot;">​</a></h3><p>当我们操作表中没有的字段时，就会抛出这个 UnknownAttributeError 未知属性的一个错误，包括查询、创建、更新等等操作，例如上面的 save！、create！、update_attributes! 等等方法，操作不存在的字段则会抛出错误 .</p><h3 id="activerecord-recordinvalid-验证规则异常" tabindex="-1"><strong>ActiveRecord::RecordInvalid 验证规则异常</strong> <a class="header-anchor" href="#activerecord-recordinvalid-验证规则异常" aria-label="Permalink to &quot;**ActiveRecord::RecordInvalid 验证规则异常**&quot;">​</a></h3><p>当我们在 Model 声明了验证规则时，操作数据的时候就要符合验证规则，当验证规则没有通过的时候就会触发 ActiveRecord::RecordInvalid 验证异常 ......</p><h3 id="activerecord-rollback-事务异常" tabindex="-1"><strong>ActiveRecord::Rollback 事务异常</strong> <a class="header-anchor" href="#activerecord-rollback-事务异常" aria-label="Permalink to &quot;**ActiveRecord::Rollback 事务异常**&quot;">​</a></h3><p>当事务发生异常时，就会触发 ActiveRecord::Rollback 错误异常了 .</p><h2 id="model-表之间的关联关系" tabindex="-1">Model <strong>表之间的关联关系</strong> <a class="header-anchor" href="#model-表之间的关联关系" aria-label="Permalink to &quot;Model **表之间的关联关系**&quot;">​</a></h2><p>一般模型都有着对应关系，比如现在要设计一个小说的系统，每本小说都有对应的作者，那么就是 Author table &lt;- Book table 这样的结构产生了对应，我们是否可以直接通过作者查询到他的著作呢 ？</p><p>答案是可以的，只要我们声明了表之间的关联关系，Model 层就会帮我们建立联系，这样就可以通过作者查到他的著作了，但是表之间的关联关系又是多样的，一对一，一对多、多对多，需要根据系统的模型应用场景去设计表的关联关系 。</p><h3 id="has-many-一对一-多对多" tabindex="-1">has_many 一对一，多对多 <a class="header-anchor" href="#has-many-一对一-多对多" aria-label="Permalink to &quot;has_many 一对一，多对多&quot;">​</a></h3><p>比如现在以博客系统为例，有 User 这样一个用户模型，一个 User 用户可能对应着有多篇 blog 博客，所以可以使用 has_many :blogs 进行关联，因为是一对多，所以这里的 blog 要使用复数形式 blogs</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ActiveRecord::Base</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    has_many </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:blogs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>而一篇 Blog 仅仅只属于一个 User 用户，这里是一对一的关联关系，所以我们可以采用 belongs_to :user 进行关联，因为是一对一，所以这里的 user 使用单数的形式就可以了 ..</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Blog</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ActiveRecord::Base</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    belongs_to </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:user</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>我们在模型层定义了关联，其实在数据库表中也默认进行了关联，比如 blogs 表的 user_id 外键是关联到了 users 表的 id 主键的 。数据库表外键的命名也同时要遵循命名约束的，例如 user_id → id ，user_ 就是我们要关联的表名称的单数形式 ...</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mode               table              column             key type</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">---------------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               users              id                 primary key （主键）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Blog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               blogs              user_id            foreign_key （外键）</span></span></code></pre></div><p>现在我们就可以进行关联查询了....</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@blogs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Blog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.all</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 因为我们这里进行了 blog -&gt; user 关联，所以我们不需要通过 blog 博客的 user_id </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 再去查询 user 用户表的 id 找到这个作者.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 因为每篇博客都对应着一个作者，则可以直接使用 blog.user.username 就可以找到这个</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 作者了. </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@blogs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |blog|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    blog.user.username</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 上面是查询到某篇博客的作者</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 同时我们也可以为一本书赋值一个作者</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@blog </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Blog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Javascript&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@blog.user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;zouzhu&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@blog.save</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@user.blogs.find_by </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ruby on rails&quot;</span></span></code></pre></div><h2 id="连接表-joins" tabindex="-1"><strong>连接表 joins</strong> <a class="header-anchor" href="#连接表-joins" aria-label="Permalink to &quot;**连接表 joins**&quot;">​</a></h2><p>Rails 提供了数据库层面关于 join 关联表查询的操作，API 提供了 joins 和 left_outer_joins 这两个方法，下面准备了两张表给下面提供素材：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>Websites</span></span>
<span class="line"><span>+----+--------------+---------------------------+-------+---------+</span></span>
<span class="line"><span>| id | name         | url                       | alexa | country |</span></span>
<span class="line"><span>+----+--------------+---------------------------+-------+---------+</span></span>
<span class="line"><span>| 1  | Google       | https://www.google.cm/    | 1     | USA     |</span></span>
<span class="line"><span>| 2  | 淘宝          | https://www.taobao.com/   | 13    | CN      |</span></span>
<span class="line"><span>| 3  | 菜鸟教程      | http://www.runoob.com/    | 4689  | CN      |</span></span>
<span class="line"><span>| 4  | 微博          | http://weibo.com/         | 20    | CN      |</span></span>
<span class="line"><span>| 5  | Facebook     | https://www.facebook.com/ | 3     | USA     |</span></span>
<span class="line"><span>| 7  | stackoverflow | http://stackoverflow.com/ |   0 | IND      |</span></span>
<span class="line"><span>+----+---------------+---------------------------+-------+---------+</span></span>
<span class="line"><span></span></span>
<span class="line"><span>access_log</span></span>
<span class="line"><span>+-----+---------+-------+------------+</span></span>
<span class="line"><span>| aid | site_id | count | date       |</span></span>
<span class="line"><span>+-----+---------+-------+------------+</span></span>
<span class="line"><span>|   1 |       1 |    45 | 2016-05-10 |</span></span>
<span class="line"><span>|   2 |       3 |   100 | 2016-05-13 |</span></span>
<span class="line"><span>|   3 |       1 |   230 | 2016-05-14 |</span></span>
<span class="line"><span>|   4 |       2 |    10 | 2016-05-14 |</span></span>
<span class="line"><span>|   5 |       5 |   205 | 2016-05-14 |</span></span>
<span class="line"><span>|   6 |       4 |    13 | 2016-05-15 |</span></span>
<span class="line"><span>|   7 |       3 |   220 | 2016-05-15 |</span></span>
<span class="line"><span>|   8 |       5 |   545 | 2016-05-16 |</span></span>
<span class="line"><span>|   9 |       3 |   201 | 2016-05-17 |</span></span>
<span class="line"><span>+-----+---------+-------+------------+</span></span></code></pre></div><h3 id="joins" tabindex="-1"><strong>joins</strong> <a class="header-anchor" href="#joins" aria-label="Permalink to &quot;**joins**&quot;">​</a></h3><ul><li>joins 就是映射的 SQL : inner join</li><li>left_outer_joins 就是映射的 left join</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1.joins 里面可以是 inner join 后面的原生 SQL</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">irb(main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):002:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> User.joins(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;inner join member_recharge_statuses mrs on mrs.username = users.password&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">User</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Load </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0.8ms</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SELECT  `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">users</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">* </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">FROM `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">users</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> inner</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> join member_recharge_statuses mrs on mrs.username = users.password LIMIT </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#&lt;ActiveRecord::Relation [#&lt;User id: 5, username: &quot;李伟&quot;, password: &quot;liwei&quot;, phone: &quot;11111738542&quot;, industry: &quot;前端&quot;, created_at: &quot;2021-11-30 09:13:43&quot;, </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   #                           updated_at: &quot;2021-11-30 09:13:43&quot;&gt;]&gt;</span></span></code></pre></div><p><img src="/services/rails/Untitled 5.png" alt="Untitled"></p><h3 id="left-outer-joins" tabindex="-1"><strong>left_outer_joins</strong> <a class="header-anchor" href="#left-outer-joins" aria-label="Permalink to &quot;**left_outer_joins**&quot;">​</a></h3><p>LEFT JOIN 也叫 LEFT OUTER JOINS ，它的包含关系如下图所示</p><p><img src="/services/rails/Untitled 6.png" alt="Untitled"></p><p><img src="/services/rails/Untitled 7.png" alt="Untitled"></p><h2 id="scopes-声明作用域查询方法" tabindex="-1"><strong>Scopes 声明作用域查询方法</strong> <a class="header-anchor" href="#scopes-声明作用域查询方法" aria-label="Permalink to &quot;**Scopes 声明作用域查询方法**&quot;">​</a></h2><p>我们可以在 model 模型文件里面定义 Scopes 方法，定义后的 Scope 则可以通过 Book 模型的实例调用这个方法，像调用类方法一样调用作用域</p><h3 id="scope-范围属性方法" tabindex="-1">scope 范围属性方法 <a class="header-anchor" href="#scope-范围属性方法" aria-label="Permalink to &quot;scope 范围属性方法&quot;">​</a></h3><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">书名            版本号          上架状态</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name           version        shelf</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   &quot;1.0.1&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        true</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Book</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # search_book symbol 方法名称我们可以随便定义，-&gt;后面是参数，也可以不用参数</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 搜索指定的书籍</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  scope </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:search_book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, version) { where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;name = ? and version = ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name, version)} </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 已经上架了的书籍</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    scope </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:shelf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shelf = true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 也可以在 scope 中调用 scope 方法.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 查询指定上架的书籍</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    scope </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:shelf_book_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name) { shelf.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;name = ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name) }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.search_book(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;疯狂的 Java&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1.0.1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)        </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.shelf.search_book                      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 方法也可以进行链式调用</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> author </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Author</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.first                       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如果进行了关联，也可以对关联模型 books 进行调用</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> author.books.shelf</span></span></code></pre></div><h3 id="self-自定义方法" tabindex="-1"><strong>self 自定义方法</strong> <a class="header-anchor" href="#self-自定义方法" aria-label="Permalink to &quot;**self 自定义方法**&quot;">​</a></h3><p>对于复杂的操作逻辑，我们也可以封装一个 self. 方法 ，同上的 scope 效果，如下代码方式定义跟上面能达到一样的效果 .</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Book</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 搜索指定的书籍</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> self.search_book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, version)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;name = ? and version = ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name, version)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 已经上架了的书籍</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> self.shelf</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 查询指定上架的书籍</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> self.shelf_book_name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        shelf.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;name = ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="default-scope-默认范围属性方法" tabindex="-1"><strong>default_scope 默认范围属性方法</strong> <a class="header-anchor" href="#default-scope-默认范围属性方法" aria-label="Permalink to &quot;**default_scope 默认范围属性方法**&quot;">​</a></h3><p>如果我们希望将 scope 范围应用于模型的所有查询，我们可以定义 default_scope 方法 。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Book</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 现在则是 Book 模型上操作的数据都应该是上架状态的.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    default_scope </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:shelf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shelf = true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 当在这个模型上执行查询时，SQL 查询现在看起来像这样：SELECT * FROM books WHERE (shelf = true)</span></span></code></pre></div><p>如果你需要使用默认范围做更复杂的事情，也可以将其定义为类方法：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Book</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.default_scope</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shelf = true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><aside> ⚠️ 当创建个新的 Book 对象时，也会默认调用 default_scope ，更新记录时不应该使用它 我们可以看到 shelf 默认值就变成了 true 如果我们创建 Book 模型的时候，不想使用这个默认的 default_scope，则可以在 Book 模型后面调用 unscoped 方法即可。 <p>注意：当条件为 Array 传参时 where(&quot;shelf = ？&quot;, true) 上面将不再生效 irb&gt; Book.new =&gt; #&lt;Book id: nil, shelf: nil&gt;</p></aside><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  =&gt; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#&lt;Book id: nil, shelf: true&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.unscoped.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  =&gt; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#&lt;Book id: nil, shelf: nil&gt;</span></span></code></pre></div><h3 id="model-自定义虚拟属性-set-get" tabindex="-1">Model 自定义虚拟属性 (set，get) <a class="header-anchor" href="#model-自定义虚拟属性-set-get" aria-label="Permalink to &quot;Model 自定义虚拟属性 (set，get)&quot;">​</a></h3><p>我们可以在 Model 模型中自定义一个虚拟的属性，提供给我们使用 。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Blog</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ActiveRecord::Base</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    has_many </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:tags</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tags_string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        @tags_string</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 创建一个 tags_string 虚拟属性</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tags_string=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> one_tags                                     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 接受多个 tag 连接的字符串</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        @tags_string </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> one_tags                                     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 保存输入</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        one_tags.split(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;,&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |tag|                           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 通过分割并循环 tags</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            one_tag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Tag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find_by(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">title:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tag)                         </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在 Tag 中是否存在这个 title</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            one_tag </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Tag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">title:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tag) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unless</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> one_tag              </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如果不存在则创建</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.tags </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> one_tag                                      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 将这个 one_tag 添加到这篇博客的标签中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h2 id="枚举映射-enums" tabindex="-1"><strong>枚举映射 Enums</strong> <a class="header-anchor" href="#枚举映射-enums" aria-label="Permalink to &quot;**枚举映射 Enums**&quot;">​</a></h2><p>枚举允许您为属性定义值数组并按名称引用它们，存储在数据库中的实际值是一个已映射到其中一个值的整数，给数据库中的整型字段声明一个一一对应的枚举属性值，这个值可以以字面量用于查询。</p><p>拿到具体的运用场景中去考虑，Enum 的主要用于数据库中类似于状态 (status) 的字段，这类字段用不同的整数 (Integer) 来表示不用的状态，如果不使用 Enum，那就意味着我们代码中会出现很多表示状态的数字，他们可能会出现在查询条件里，也可能会出现在判断条件里，除非你记得或者拿着数据字典去看，否则你很难理解这段代码的含义，代码中以数字方式去表示数据状态，导致代码可读性被破坏，这样的数字被称为『魔鬼数字』，Enum 就是 Rails 用来消灭魔鬼数字的工具。</p><ul><li>创建可用于查找具有或不具有枚举值之一的所有对象的范围</li><li>创建一个实例方法，可用于确定对象是否具有枚举的特定值</li><li>创建可用于更改对象枚举值的实例方法</li></ul><p><a href="https://ruby-china.org/topics/28654" target="_blank" rel="noreferrer">Rails 关于在 Rails Model 中使用 Enum (枚举) 的若干总结</a></p><p>ActiveRecord::Enum 的使用，枚举声明之后，会多出以下一些辅助方法，例如 scope：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 注意即使是不同的 enum 字段也不能有同名的值，因为它具有唯一性，在创建枚举的同时 Rails 也帮我们创建了一些属性列方法，所以千万不要重名</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MemberRechargeStatus</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # status 用户充值状态 monthly_fee:0(月费) year_fee:1(年费)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # active 用户活跃状态 lazy:0(懒惰) active:1(活跃)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">monthly_fee:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">year_fee:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lazy:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 当我们创建了 enum 属性集合，就可以通过这个属性去查询，如下等价于 Conversation.where(status: 0)，类似 Rails 自动帮我们创建了 scope 方法，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 其实都是 Rails 自动帮我们创建的，还有下面的 ? 、! 等一些列方法.....</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">011</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.monthly_fee</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如果你想获取所有的 active 状态，并以 hash 的形态返回，只需要调用 actives 就可以了，这里是复数表示多个状态，返回 actives 的 HashWithIndifferentAccess</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">011</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.actives     </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lazy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;active&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">013</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.actives[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:lazy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">014</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.actives[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lazy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 返回的结果集里面的每个对象，都可以调用枚举方法属性，例如下面的 lazy?、active?、lazy!</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 下面案例查询 active: 0 并返回第一条数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):008:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> member_status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.lazy.first   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#&lt;MemberRechargeStatus id: 1, username: &quot;zou,zhu&quot;, status: &quot;monthly_fee&quot;, active: &quot;lazy&quot;, created_at: &quot;2021-12-01 09:13:43&quot;, updated_at: &quot;2021-12-01 09:13:43&quot;&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):009:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> member_status.lazy?       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 这条数据是否有 active = lazy -&gt; 0 状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">010</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> member_status.active?     </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 这条数据是否有 active = active -&gt; 1 状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">011</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> member_status.lazy!  </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.3ms)  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.7ms)  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">COMMIT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><p><strong>枚举定义注意事项 ：</strong></p><p>下面这种定义枚举的形式，尽量不要使用，symbol 键 value 默认对应的值是索引值，例如这种解析方式 [ :active, :waiting, :archived ] → [ active: 0, waiting: 1, archived:2 ] ，相比起使用 Hash，数组相当于隐式指定了数字键值，字面量的顺序就很关键，你无法保证每个可能改这处代码的人都深知这一点，而一旦被插值或者打乱顺序，可能会导致几个通宵的加班。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:waiting</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:archived</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i[active waiting archived]</span></span></code></pre></div><p><strong>ActiveRecord::Enum 在 Rails 5.0+ 中的新特性 ：</strong></p><ul><li>1、where 查询支持直接使用字面量做查询条件</li></ul><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 输出 `active` IN (0, 1)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">015</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i[lazy active])</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  MemberRechargeStatus</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.1ms)  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SELECT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  `member_recharge_statuses`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `member_recharge_statuses`</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> WHERE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `member_recharge_statuses`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`active`</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> IN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">LIMIT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 11</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#&lt;ActiveRecord::Relation [#&lt;MemberRechargeStatus id: 1, username: &quot;zou,zhu&quot;, status: &quot;monthly_fee&quot;, active: &quot;lazy&quot;, created_at: &quot;2021-12-01 09:13:43&quot;, updated_at: &quot;2021-12-01 09:13:43&quot;&gt;, #&lt;MemberRechargeStatus id: 2, username: &quot;huang,shuangting&quot;, status: &quot;monthly_fee&quot;, active: &quot;active&quot;, created_at: &quot;2021-12-01 09:13:43&quot;, updated_at: &quot;2021-12-01 09:13:43&quot;&gt;, #&lt;MemberRechargeStatus id: 3, username: &quot;liwei&quot;, status: &quot;year_fee&quot;, active: &quot;lazy&quot;, created_at: &quot;2021-12-01 09:13:43&quot;, updated_at: &quot;2021-12-01 09:13:43&quot;&gt;, #&lt;MemberRechargeStatus id: 4, username: &quot;yang,zong&quot;, status: &quot;year_fee&quot;, active: &quot;active&quot;, created_at: &quot;2021-12-01 09:13:43&quot;, updated_at: &quot;2021-12-01 09:13:43&quot;&gt;]&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 打印执行的SQL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">016</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i[lazy active]).to_sql</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SELECT `member_recharge_statuses`.* FROM `member_recharge_statuses` WHERE `member_recharge_statuses`.`active` IN (0, 1)&quot;</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rails 不同版本的写法，以及注意事项：</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在 Rails 4.1+ 中</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i[lazy active]).to_sql</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; &quot;SELECT `conversations`.* FROM `conversations` WHERE `conversations`.`status` IN (NULL, NULL)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 惊不惊喜，意不意外，这也是 4.x 版本 Enum 比较鸡肋的原因，正确的你应这样写</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i[lazy active].map { |s| </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.statuses[s] }).to_sql</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; &quot;SELECT `conversations`.* FROM `conversations` WHERE `conversations`.`status` IN (0, 1)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 好在，Rails 5.0 之后就可以这么用了</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">active:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i[lazy active]).to_sql</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; &quot;SELECT \\&quot;conversations\\&quot;.* FROM \\&quot;conversations\\&quot; WHERE \\&quot;conversations\\&quot;.\\&quot;status\\&quot; IN (0, 1)&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># BUT，当你选择手写 SQL 查询条件的时候，仍是需要自己转义的</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;active &lt;&gt; ?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MemberRechargeStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.statuses[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:lazy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><ul><li>2、conversation[:status] 与 conversation.status 返回值一致，都是字面量</li></ul><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Rails 4.1+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">conversation.status </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; &quot;active&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">conversation[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; 0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Conversation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; [0, 1, 2, 1, ...]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Rails 5.0+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">conversation.status </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; &quot;active&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">conversation[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; &quot;active&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Conversation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.pluck(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; [&quot;active&quot;, &quot;waiting&quot;, &quot;archived&quot;, &quot;waiting&quot;, ...]</span></span></code></pre></div><ul><li>3、增加了两个可选参数 _prefix 和 _suffix 在 Rails 4.1+ 的版本中，即使是不同的 enum 字段也不能有同名的值，于是在 Rails 5 中，引入了_prefix 和 _suffix 两个选项来解决这个问题，它会给对应的 !、? 以及 scope 方法加上前/后缀以示区分</li></ul><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># user.rb</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:temporary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:deleted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">admin_status:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:super_admin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rails console 实例化会报错</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">001</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> u </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ArgumentError:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> You</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tried to define an enum named </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;admin_status&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> on the model </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">but this will generate a instance method </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;active?&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, which is already defined by another enum.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># user.rb</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:temporary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:deleted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">_suffix:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">admin_status:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:super_admin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rails console</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.active_status.first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user.active_status?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user.deleted_status!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># user.rb</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">status:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:temporary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:deleted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">_suffix:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :stat</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  enum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">admin_status:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:super_admin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rails console</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.active_stat.first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user.active_stat?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  user.deleted_stat!</span></span></code></pre></div><h2 id="model-验证与回调" tabindex="-1">Model 验证与回调 <a class="header-anchor" href="#model-验证与回调" aria-label="Permalink to &quot;Model 验证与回调&quot;">​</a></h2><h3 id="字段验证" tabindex="-1">字段验证 <a class="header-anchor" href="#字段验证" aria-label="Permalink to &quot;字段验证&quot;">​</a></h3><p>Active Record 允许您在模型写入数据库之前验证模型的状态，您可以使用多种方法来检查模型并验证属性值是否为空、是否唯一且不在数据库中、是否遵循特定格式等等 ：<a href="https://guides.rubyonrails.org/active_record_validations.html" target="_blank" rel="noreferrer">Active Record 验证指南</a></p><p>验证是持久化到数据库时要考虑的一个非常重要的问题，因此这些方法 <code>save</code> 和 <code>update</code>运行时要考虑到：<code>false</code>验证失败时它们返回并且它们实际上并不对数据库执行任何操作，所有这些都有一个 bang 对应物（即 <code>save!</code>and <code>update!</code>），它们更严格，因为 <code>ActiveRecord::RecordInvalid</code>如果验证失败，它们会引发异常，一个简单的例子来说明：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 验证规则: name,password 这些字段，presence 不能为空</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    validates </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">presence:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UsersController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationController</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> descript</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_anthor(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zhu,zou&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;123456&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create_anthor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(username, password)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 当缺少username字段，工程则会报错，下面是报错信息</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # NoMethodError (undefined method `name&#39; for #&lt;User:0x00007fb5edb4b5b8&gt;):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">password:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> password)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 可以通过 save! 或 update! 手动获取错误输出</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="model-模型回调-生命周期" tabindex="-1">Model 模型回调(生命周期) <a class="header-anchor" href="#model-模型回调-生命周期" aria-label="Permalink to &quot;Model 模型回调(生命周期)&quot;">​</a></h3><p>Active Record 回调允许您将代码附加到模型生命周期中的某些事件，这使您能够通过在这些事件发生时透明地执行代码来向模型添加行为，例如当您创建新记录、更新它、销毁它等时，以便您可以控制您的应用程序及其数据 : <a href="https://guides.rubyonrails.org/active_record_callbacks.html" target="_blank" rel="noreferrer">Active Record 回调指南</a></p><p>回调是在对象生命周期的特定时刻被调用的方法，使用回调可以编写在 Active Record 对象被创建、保存、更新、删除、验证或从数据库加载时运行的代码，如何注册回调呢 ？</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># model</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 验证规则: username 这个字段，presence 不能为空</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    validates </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">presence:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 注册回调，可以定义一个函数，然后挂在 before_validation 后面，</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 在数据创建的时候就会执行了</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    before_validation </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:ensure_login_has_a_value</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 模拟在注册的时候,将用户转化为MD5</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # self.username 可以修改即将保存的 username 字段</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ensure_login_has_a_value</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     puts</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;username model : </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{username}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.username </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;MD5 </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">#{username}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># controller</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UsersController</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationController</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> descript</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create_anthor(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Li,Bai&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;fn123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> create_anthor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(username, password)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">username:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> username, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">password:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> password</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><table><thead><tr><th>生命周期</th><th>阶段</th><th>描述</th></tr></thead><tbody><tr><td>before_validation</td><td>创建对象阶段, 更新对象阶段</td><td>定义将在验证前立即调用的回调</td></tr><tr><td>after_validation</td><td>创建对象阶段, 更新对象阶段</td><td>定义将在验证后立即调用的回调</td></tr><tr><td>before_save</td><td>创建对象阶段, 更新对象阶段</td><td>在保存记录之前注册要调用的回调注册一个回调以在记录保存时调用</td></tr><tr><td>around_save</td><td>创建对象阶段, 更新对象阶段</td><td>注册一个回调以在记录保存时调用</td></tr><tr><td>before_create</td><td>创建对象阶段, 更新对象阶段</td><td>在创建记录之前注册要调用的回调</td></tr><tr><td>around_create</td><td>创建对象阶段, 更新对象阶段</td><td>注册在创建记录时要调用的回调</td></tr><tr><td>after_create</td><td>创建对象阶段, 更新对象阶段</td><td>注册在创建记录后调用的回调</td></tr><tr><td>after_save</td><td>创建对象阶段, 更新对象阶段</td><td>注册一个回调以在保存记录后调用</td></tr><tr><td>after_commit</td><td>创建对象阶段, 更新对象阶段, 销毁对象阶段</td><td>在创建、更新或销毁记录后调用此回调</td></tr><tr><td>after_rollback</td><td>创建对象阶段, 更新对象阶段, 销毁对象阶段</td><td>在创建、更新或销毁回滚后调用此回调</td></tr><tr><td>before_destroy</td><td>销毁对象阶段</td><td>注册在记录被销毁之前要调用的回调</td></tr><tr><td>around_destroy</td><td>销毁对象阶段</td><td>注册一个回调以在记录销毁时调用</td></tr><tr><td>after_destroy</td><td>销毁对象阶段</td><td>注册一个回调以在记录被销毁后调用</td></tr></tbody></table><h3 id="事件回调" tabindex="-1">事件回调 <a class="header-anchor" href="#事件回调" aria-label="Permalink to &quot;事件回调&quot;">​</a></h3><p><mark>回调方法</mark></p><ol><li><p>create</p></li><li><p>create!</p></li><li><p>destroy</p></li><li><p>destroy!</p></li><li><p>destroy_all</p></li><li><p>destroy_by</p></li><li><p>save</p></li><li><p>save!</p></li><li><p>save(validate: false)</p></li><li><p>toggle!</p></li><li><p>touch</p></li><li><p>update_attribute</p></li><li><p>update</p></li><li><p>update!</p></li><li><p>valid?</p></li></ol><p><mark>跳过回调</mark></p><ol><li><p>decrement!</p></li><li><p>decrement_counter</p></li><li><p>delete</p></li><li><p>delete_all</p></li><li><p>delete_by</p></li><li><p>increment!</p></li><li><p>increment_counter</p></li><li><p>insert</p></li><li><p>insert!</p></li><li><p>insert_all</p></li><li><p>insert_all!</p></li><li><p>touch_all</p></li><li><p>update_column</p></li><li><p>update_columns</p></li><li><p>update_all</p></li><li><p>update_counters</p></li><li><p>upsert</p></li><li><p>upsert_all</p></li></ol><p><mark>回调顺序</mark><br><u>3.1 Creating an Object (创建阶段)</u></p><ol><li><p>before_validation</p></li><li><p>after_validation</p></li><li><p>before_save</p></li><li><p>around_save</p></li><li><p>before_create</p></li><li><p>around_create</p></li><li><p>after_create</p></li><li><p>after_save</p></li><li><p>after_commit / after_rollback</p></li></ol><p><u>3.2 Updating an Object (更新对象)</u></p><ol><li><p>before_validation</p></li><li><p>after_validation</p></li><li><p>before_save</p></li><li><p>around_save</p></li><li><p>before_update</p></li><li><p>around_update</p></li><li><p>after_update</p></li><li><p>after_save</p></li><li><p>after_commit / after_rollback</p></li></ol><p><u>3.3 Destroying an Object (删除对象)</u></p><ol><li><p>before_destroy</p></li><li><p>around_destroy</p></li><li><p>after_destroy</p></li><li><p>after_commit / after_rollback</p></li></ol><p><mark>回调版本改动</mark><br> attribute_changed? attribute_change 等方法在5.1后before_save, before_update里还可以继续用，在after_save, after_update里不能用</p><table><thead><tr><th>Rails 5.0- (before_save, before_update)</th><th>Rails 5.1+ (before_save, before_update)</th><th>Rails 5.1+ (after_save, after_update)</th></tr></thead><tbody><tr><td>attribute_changed?</td><td>will_save_change_to_attribute?</td><td>saved_change_to_attribute?</td></tr><tr><td>attribute_change</td><td>attribute_change_to_be_saved</td><td>saved_change_to_attribute</td></tr><tr><td>attribute_was</td><td>attribute_in_database</td><td>attribute_before_last_save</td></tr><tr><td>changes</td><td>changes_to_save</td><td>saved_changes</td></tr><tr><td>changed?</td><td>has_changes_to_save?</td><td>saved_changes?</td></tr><tr><td>changed</td><td>changed_attribute_names_to_save</td><td>saved_changes.keys</td></tr><tr><td>changed_attributes</td><td>attributes_in_database</td><td>saved_changes.transform_values(&amp;:first)</td></tr></tbody></table><h3 id="rake-迁移" tabindex="-1">rake 迁移 <a class="header-anchor" href="#rake-迁移" aria-label="Permalink to &quot;rake 迁移&quot;">​</a></h3><p>db/migrate/20211129142348_create_users.rb 表结构，工程里仅仅需要定义好字段，执行迁移命令，就可以自动帮我们创建表了.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rails g model user </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rake db:migrate</span></span></code></pre></div><h2 id="事务与锁的应用" tabindex="-1"><strong>事务与锁的应用</strong> <a class="header-anchor" href="#事务与锁的应用" aria-label="Permalink to &quot;**事务与锁的应用**&quot;">​</a></h2><p>锁定有助于在更新数据库中的记录时，防止竞争条件并确保原子更新（防止竞争的意思就是当两个操作同时操作一条记录的时候，拿到锁的相当于把门锁上了，后面的只能等着排队，只有当完成自己的操作，才会打开锁并重新释放锁，后面的才能重新拿到锁依次更新，这样操作的好处就是防止数据污染），Active Record 提供了两种锁定机制 ：( 乐观锁定、悲观锁定 ) 。</p><p>例子 ：比如账户中有 100 块钱，一个操作要扣 10 块钱，另一个操作要扣5块钱，最后我们就还剩 85 块钱，这是理想中的结果 。但是如果这两个操作同时进行，他们都查到账户中还有 100 ，它们分别 -10、-5，因为是同时进行的可能就会得到 90 或 95 这两个结果，可以发现这其实就造成了数据污染 。如果上了锁，它们就只能排队拿锁，依次更新了，这样就保证了数据的原子性 。</p><h3 id="lock-version-乐观锁" tabindex="-1">lock_version 乐观锁 <a class="header-anchor" href="#lock-version-乐观锁" aria-label="Permalink to &quot;lock_version 乐观锁&quot;">​</a></h3><p>乐观锁允许多个用户访问同一条记录以进行编辑，假定数据冲突最小，他将检查其他程序是否对这条已读到的记录有修改，如果该记录已经被修改了，则放弃本次修改，并且抛出异常 ActiveRecord::StaleObjectError . 查看 ActiveRecord::Locking::Pessimistic 以获取替代方案 。</p><p>表中需要有一个 lock_version 整数类型的列，如果表上存在 lock_version 字段的话，Active Record 就提供乐观锁支持，每次更新记录时 Active Record 都会增加该lock_version 字段加一，如果更新请求的 lock_version 字段中的值低于 lock_version 数据库中当前列中的值，则更新请求将失败并显示 StaleObjectError 。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 查询记录两次实例化为两个变量, 如果第一个变量发生了更新, 那么锁会确保后一个抛 StaleObjectError .</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 如果此时数据库中 customers 表中的 lock_version 现在是 10</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># c1 和 c2 因为是同时并发执行 save 操作，携带的 lock_version += 1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># c1 此时 lock_version 是 11 大于 10 则能更新成功，数据库中的 lock_version 就更新为 11 了</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># c2 此时还是 11 等于数据库中 lock_version:11，就会抛出 ActiveRecord::StaleObjectError 错误了</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Customer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c1.first_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Sandra&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                                </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c1.save                                                     </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c2.first_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Michael&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c2.save </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Raises an ActiveRecord::StaleObjectError</span></span></code></pre></div><p>抛出 StaleObjectError 错误，你可以监听错误，然后可以通过 transtion 事务修复业务异常并回滚数据、因为 Rails 默认是打开乐观锁的，你可以通过设置来关闭此行为 ActiveRecord::Base.lock_optimistically = false .</p><p>要覆盖 lock_version 列的名称，请使用 ActiveRecord::Base 提供的一个类属性 locking_column：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Customer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.locking_column </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :lock_customer_column</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="lock-悲观锁" tabindex="-1">lock 悲观锁 <a class="header-anchor" href="#lock-悲观锁" aria-label="Permalink to &quot;lock 悲观锁&quot;">​</a></h3><p>一般对于资源的争用都可以使用悲观锁，比如电商系统中涉及到订单的部分，比如用户支付完成后可能会同时有多条支付成功的通知（做过支付的都知道一般有同步通知和异步通知），比如订单改价的同时可能用户正在支付等等，对于这种会对订单状态发生改变的操作，我们内部一般对这种操作都做加锁处理，Rails API 文档中有详细的说明 ：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># select * from accounts where id=1 for update</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Account</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.lock.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 注意，这种最终会导致一个行锁</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># select * from accounts where name = &#39;shugo&#39; limit 1 for update</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Account</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;name = &#39;shugo&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).lock(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).first</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 注意，这里可不是行锁，这里会是一个表锁</span></span></code></pre></div><p>注意上面的区别 mysql innodb 里面，对于 &quot;select * from where xxx for update&quot; 的情况，是会锁住整张表的，所以最好不要这样来用。Rails 也提供了一个很方便的方法 with_lock 来锁住单个记录，并且内嵌在事务之中，下面代码中的两段是等价的：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateAccount</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    account </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Account</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 和下面是等价的</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    Account</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.transaction </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    account.lock!</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    account.balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    account.save! </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 和下面是等价的</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    account.with_lock </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    account.balance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    account.save!</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>您还可以将原始 SQL 传递 lock 给允许不同类型锁的方法。例如 MySQL 有一个表达式 LOCK IN SHARE MODE，您可以在其中锁定一条记录，但仍允许其他查询读取它，要指定此表达式，只需将其作为锁定选项传入，请注意您的数据库必须支持您传递给 lock 方法的原始 SQL 才行。</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.transaction </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  book </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.lock(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;LOCK IN SHARE MODE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  book.increment!(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:views</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="乐观锁与悲观锁的应用场景" tabindex="-1">乐观锁与悲观锁的应用场景 <a class="header-anchor" href="#乐观锁与悲观锁的应用场景" aria-label="Permalink to &quot;乐观锁与悲观锁的应用场景&quot;">​</a></h3><p>悲观锁（Pessimistic Lock）：</p><p>每次获取数据的时候，都会担心数据被修改，所以每次获取数据的时候都会进行加锁，确保在自己使用的过程中数据不会被别人修改，使用完成后进行数据解锁。由于数据进行加锁，期间对该数据进行读写的其他线程都会进行等待。</p><p>乐观锁（Optimistic Lock）：</p><p>每次获取数据的时候，都不会担心数据被修改，所以每次获取数据的时候都不会进行加锁，但是在更新数据的时候需要判断该数据是否被别人修改过。如果数据被其他线程修改，则不进行数据更新，如果数据没有被其他线程修改，则进行数据更新。由于数据没有进行加锁，期间该数据可以被其他线程进行读写操作。</p><p><strong>适用场景：</strong></p><p>悲观锁：比较适合写入操作比较频繁的场景，如果出现大量的读取操作，每次读取的时候都会进行加锁，这样会增加大量的锁的开销，降低了系统的吞吐量。</p><p>乐观锁：比较适合读取操作比较频繁的场景，如果出现大量的写入操作，数据发生冲突的可能性就会增大，为了保证数据的一致性，应用层需要不断的重新获取数据，这样会增加大量的查询操作，降低了系统的吞吐量。</p><p>总结：两种所各有优缺点，读取频繁使用乐观锁，写入频繁使用悲观锁。</p><p>像乐观锁适用于写比较少的情况下，即冲突真的很少发生的时候，这样可以省去了锁的开销，加大了系统的整个吞吐量。但如果经常产生冲突，上层应用会不断的进行retry，这样反倒是降低了性能，所以这种情况下用悲观锁就比较合适,之所以用悲观锁就是因为两个用户更新同一条数据的概率高，也就是冲突比较严重的情况下，所以才用悲观锁.</p><p>悲观锁比较适合强一致性的场景，但效率比较低，特别是读的并发低。乐观锁则适用于读多写少，并发冲突少的场景。</p><p><strong>适用场景：</strong></p><p>当竞争不激烈(出现并发冲突的概率小)时，乐观锁更有优势，因为悲观锁会锁住代码块或数据，其他线程无法同时访问，影响并发，而且加锁和释放锁都需要消耗额外的资源。 当竞争激烈(出现并发冲突的概率大)时，悲观锁更有优势，因为乐观锁在执行更新时频繁失败，需要不断重试，浪费CPU资源。</p><h2 id="modal-关联模型" tabindex="-1">Modal 关联模型 <a class="header-anchor" href="#modal-关联模型" aria-label="Permalink to &quot;Modal 关联模型&quot;">​</a></h2><h3 id="为什么要关联模型" tabindex="-1">为什么要关联模型 ? <a class="header-anchor" href="#为什么要关联模型" aria-label="Permalink to &quot;为什么要关联模型 ?&quot;">​</a></h3><p>在 Rails 中，关联是两个 Active Record 模型之间的连接，为什么我们需要模型之间的关联 ？因为它们使您的代码中的常见操作变得更加简单和容易，例如考虑一个简单的 Rails 应用程序，其中包括一个作者模型和一个书籍模型，每个作者可以拥有多本书，如果没有关联，模型声明将如下所示：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Author</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Book</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 假设我们想为现有作者添加一本新书，我们需要做这样的事情 ：首先查询到作者，然后创建 book</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@author </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Author</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.find(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@book </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">published_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.now, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">author_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @author.id)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 或者考虑删除作者，并确保其所有书籍也被删除：通过作者id，查询出所有书籍，然后循环删除，然后在将作者 @author 删除</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@books </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Book</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">author_id:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @author.id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@books.each </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> |book|</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  book.destroy</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@author.destroy</span></span></code></pre></div><p>使用 Active Record 关联，我们可以通过声明性地告诉 Rails 两个模型之间存在连接来简化这些和其他操作，这是用于设置作者和书籍的修订代码 ：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Author</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 表示一对多的关联</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  has_many </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:books</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dependent:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> :destroy</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Book</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 从属于哪一个上级</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  belongs_to </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:author</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 通过此更改，为特定作者创建新书变得更加容易</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@book </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @author.books.create(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">published_at:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.now)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 删除作者及其所有书籍要容易得多</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@author.destroy</span></span></code></pre></div><p>我创建了 anthor，book 两张表 ，并验证了上面的写法，能生成一本书的数据</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rails 环境去操作一条数据：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">004</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @author </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Author</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.where(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">author_id:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 101</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).last</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">irb(main):</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">010</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @author.books.create </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;JavaScriptCode,2021&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.4ms)  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BEGIN</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SQL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.7ms)  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">INSERT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> INTO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `books`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`author_id`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`name`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`created_at`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`updated_at`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;JavaScriptCode,2021&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021-12-01 09:32:24&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;2021-12-01 09:32:24&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.5ms)  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">COMMIT</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 我们发现创建的 author_id 指向的是用户的 id 1 既主键，所以我们不用在用户表中创建 author_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">author_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">created_at         </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">updated_at         </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--+---------+----+-------------------+-------------------+</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      101</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">邹柱  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      102</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">黄双婷 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      103</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">李伟  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      104</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">杨总  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">author_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name               </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">descript</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">price</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">number     </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">created_at         </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">updated_at         </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--+---------+-------------------+--------+-----+-----------+-------------------+-------------------+</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      101</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">钢铁是怎样炼成的           </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">励志类书籍   </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   12</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10119981001</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">JavaScriptCode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     |</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">           |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">01</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">24</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2021</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">01</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 09:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">24</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span></code></pre></div><h3 id="模型关联类型" tabindex="-1">模型关联类型 <a class="header-anchor" href="#模型关联类型" aria-label="Permalink to &quot;模型关联类型&quot;">​</a></h3><p>Rails 支持六种类型的关联，关联是使用宏样式调用实现的，因此您可以向模型中声明性地添加功能，例如通过声明一个模型 belongs_to 另一个，您指示 Rails 维护两个模型实例之间的主键-外间信息，并且您还可以将许多实用方法添加到您的模型中，官网全文如下所示 ：</p><p><a href="https://guides.rubyonrails.org/association_basics.html#the-has-many-association" target="_blank" rel="noreferrer">Active Record Associations - Ruby on Rails Guides</a></p><ul><li><code>[belongs_to](https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to)</code></li><li><code>[has_one](https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one)</code></li><li><code>[has_many](https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many)</code></li><li><code>[has_many :through](https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many)</code></li><li><code>[has_one :through](https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one)</code></li><li><code>[has_and_belongs_to_many](https://api.rubyonrails.org/v6.1.4/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many)</code></li></ul><h3 id="belongs-to" tabindex="-1">belongs_to <a class="header-anchor" href="#belongs-to" aria-label="Permalink to &quot;belongs_to&quot;">​</a></h3><p>如果您的应用程序包括作者和书籍，并且每本书都可以有一个作者，那么您可以声明本模型 belongs_to</p><aside> 💡 belongs_to 关联*必须*使用单数术语。如果您在上面的示例中使用复数形式 author 作为 book 模型中的关联并尝试通过来创建实例，您将被告知有一个“未初始化的常量 Book::Authors”，这是因为 Rails 会自动从关联名称推断类名称，如果关联名称被错误地复数化，那么推断的类也会被错误地复数化。 </aside><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Book</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  belongs_to </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:author</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><img src="/services/rails/Untitled 8.png" alt="Untitled"></p><h3 id="has-one" tabindex="-1">has_one <a class="header-anchor" href="#has-one" aria-label="Permalink to &quot;has_one&quot;">​</a></h3><p>如果您的应用程序中的每个供应商只有一个帐户，您可以像这样声明供应商模型：</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Supplier</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  has_one </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:account</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><img src="/services/rails/Untitled 9.png" alt="Untitled"></p><h3 id="has-many" tabindex="-1">has_many <a class="header-anchor" href="#has-many" aria-label="Permalink to &quot;has_many&quot;">​</a></h3><p>一个 has_many 关联是类似 has_one 的，但表示与其它模型一个一对多的连接，您经常会在关联的“另一侧”找到此 belongs_to 关联，这种关联表明模型的每个实例都有零个或多个另一个模型的实例，例如在包含作者和书籍的应用程序中，作者模型可以这样声明：</p><aside> 💡 在声明 has_many 关联时，另一个模型的名称是复数形式 </aside><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Author</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ApplicationRecord</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  has_many </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:books</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><img src="/services/rails/Untitled 10.png" alt="Untitled"></p><h2 id="数据库操作" tabindex="-1">数据库操作 <a class="header-anchor" href="#数据库操作" aria-label="Permalink to &quot;数据库操作&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">migrate</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> db</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-b77f9094><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"readme.md\":\"CKPCF378\",\"document_develop_寻找远程开发工作.md\":\"BDXnZLqf\",\"api-examples.md\":\"CrhrajDt\",\"document_develop_index.md\":\"77YEIVD6\",\"document_develop_简历_index.md\":\"BVHywf9N\",\"document_develop_独立开发应用部署.md\":\"DnDShfMM\",\"document_develop_简历_服务器简历.md\":\"D94eFIJN\",\"document_english_index.md\":\"CJGZJ99f\",\"document_english_语法.md\":\"BRtNQn4s\",\"document_develop_简历_前端简历.md\":\"BzeUZ-kR\",\"document_develop_简历_个人综合简历.md\":\"Bfdka-t7\",\"document_index.md\":\"ClUoIf-9\",\"document_services_index.md\":\"CK8LITwc\",\"document_services_golang_index.md\":\"BjLta1su\",\"document_services_linux_docker容器引擎.md\":\"D9nxxYC2\",\"document_services_golang_golang 基础编程.md\":\"D6YeGKvI\",\"document_services_linux_elasticsearch数据库操作.md\":\"oeHgoRwn\",\"document_services_linux_ngnix代理服务器.md\":\"Yu8uokcS\",\"document_services_linux_shell命令脚本.md\":\"eDZCEOwg\",\"document_services_linux_index.md\":\"BCcupQ-E\",\"document_services_linux_常用基础命令.md\":\"LwXRTk38\",\"document_services_linux_文件目录配置.md\":\"9_NJBsNe\",\"document_services_linux_redis数据库操作.md\":\"CEM7ck74\",\"document_services_node_index.md\":\"CoDpqrQ4\",\"document_services_node_nestjs_nestjs 安装与配置.md\":\"CPHTWkY3\",\"document_services_python_fastapi_fastapi 安装与配置.md\":\"CPice0Wg\",\"document_services_linux_运维常见场景操作.md\":\"CD5NxJ4i\",\"document_services_python_版本管理工具.md\":\"oL_97yXU\",\"document_services_ruby_index.md\":\"CvpRd9bL\",\"document_services_python_index.md\":\"CJPmhK7Y\",\"document_services_python_语法基础.md\":\"BkslJCcs\",\"document_services_ruby_ruby 基础.md\":\"BM4nNrj-\",\"document_services_ruby_rails_rails cache 缓存.md\":\"Cc8B4FtU\",\"document_services_ruby_rails_rails mailer 发送邮件.md\":\"aHMZ0yOj\",\"document_services_ruby_rails_rails controller 控制器.md\":\"Drgs0WoA\",\"document_services_ruby_rails_rails 集成 sidekiq 队列.md\":\"DyErh2SW\",\"document_services_ruby_rails_rails setting 约定配置.md\":\"CY7VL4B2\",\"document_services_ruby_rails_rails session、cookie、token 凭证及数据闪存.md\":\"C4cMAreA\",\"document_services_ruby_rails_rails routing 路由器.md\":\"C3HV4En_\",\"document_services_ruby_rails_rails 安装与配置.md\":\"4F6E9SlP\",\"document_services_ruby_rails_rails view 视图层.md\":\"eBQr51ko\",\"document_services_ruby_版本管理工具.md\":\"BebNn6J3\",\"document_services_ruby_rails_rails 集成 whenever 定时任务.md\":\"D0dbf4Mi\",\"document_views_flutter_index.md\":\"CEAtUF2Q\",\"document_views_flutter_widget component 组件、控件.md\":\"BOI-3TaM\",\"document_services_ruby_rails_rails model 数据模型层.md\":\"CIjdELca\",\"document_views_vue_vue报错总结归纳.md\":\"BSzYfKRr\",\"document_views_flutter_语法基础创建应用.md\":\"CP0sZj1N\",\"document_views_vue_index.md\":\"SDXP3JyK\",\"document_workers_index.md\":\"CsojfSft\",\"document_views_前端常用代码段.md\":\"CGm5fHo_\",\"document_workers_timehut_bebememo 服务管理.md\":\"DRUd6uSH\",\"document_views_index.md\":\"DTeGgiAg\",\"document_workers_timehut_index.md\":\"BWGtjA_M\",\"index.md\":\"oH1qvuPp\",\"document_workers_timehut_数据库表.md\":\"CeIi_YT0\",\"document_workers_timehut_接口文档.md\":\"49Uuwxm6\",\"markdown-examples.md\":\"D4AIviKM\",\"markdown.md\":\"Cn_0K8eS\",\"document_workers_timehut_小屋服务启动管理.md\":\"DGDxtlOM\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"VitePress\",\"description\":\"bolg ...\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/logo.png\",\"siteTitle\":false,\"search\":{\"provider\":\"local\"},\"outline\":{\"label\":\"目录大纲\",\"level\":\"deep\"},\"nav\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"联系我\",\"link\":\"mailto:zouzhuqorg@gmail.com\"}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/zouzhu-code-89\"},{\"icon\":\"twitter\",\"link\":\"...\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>